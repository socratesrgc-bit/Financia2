<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Ingresos y Gastos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Fuente Inter por defecto y estilo de fondo */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* Ocultar la barra de desplazamiento en los contenedores de listas */
        .list-container {
            max-height: 250px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen flex items-start justify-center">

    <div class="div w-full max-w-4xl bg-white shadow-2xl rounded-xl p-6 sm:p-8">

        <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">Control Financiero (Soles Peruanos)</h1>
        <div id="auth-status" class="text-sm text-center text-gray-500 mb-6">Cargando autenticación...</div>

        <div class="grid grid-cols-3 gap-4 mb-8">
            <div id="total-ingresos" class="bg-green-500 text-white p-4 rounded-lg text-center shadow-lg">
                <div class="text-lg">TOTAL INGRESOS</div>
                <div id="total-income" class="text-3xl font-bold">S/ 0.00</div>
            </div>
            <div id="total-gastos" class="bg-red-500 text-white p-4 rounded-lg text-center shadow-lg">
                <div class="text-lg">TOTAL GASTOS</div>
                <div id="total-expenses" class="text-3xl font-bold">S/ 0.00</div>
            </div>
            <div id="balance-neto" class="bg-blue-500 text-white p-4 rounded-lg text-center shadow-lg">
                <div class="text-lg">BALANCE NETO</div>
                <div id="net-balance" class="text-3xl font-bold">S/ 0.00</div>
            </div>
        </div>

        <div class="bg-blue-100 p-4 rounded-lg mb-8">
            <label for="month-filter" class="block text-blue-800 font-semibold mb-2">Filtrar por Mes:</label>
            <select id="month-filter" class="w-full p-2 border border-blue-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </select>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
            <div class="bg-green-50 p-6 rounded-xl border-2 border-green-200 shadow-md">
                <h2 class="text-xl font-bold text-green-700 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Registrar Ingreso
                </h2>
                <input id="income-name" type="text" placeholder="Ej: Salario, Venta, Regalo" class="w-full p-3 mb-3 border border-gray-300 rounded-md focus:border-green-500" required>
                <input id="income-amount" type="number" placeholder="S/ 0.00" class="w-full p-3 mb-4 border border-gray-300 rounded-md focus:border-green-500" required>
                <button onclick="window.addIncome()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-md shadow-lg transition duration-200">
                    Añadir Ingreso
                </button>
            </div>

            <div class="bg-red-50 p-6 rounded-xl border-2 border-red-200 shadow-md">
                <h2 class="text-xl font-bold text-red-700 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 12H6m6 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Registrar Gasto
                </h2>
                <input id="expense-name" type="text" placeholder="Ej: Alquiler, Comida, Transporte" class="w-full p-3 mb-3 border border-gray-300 rounded-md focus:border-red-500" required>
                <input id="expense-amount" type="number" placeholder="S/ 0.00" class="w-full p-3 mb-4 border border-gray-300 rounded-md focus:border-red-500" required>
                <button onclick="window.addExpense()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-md shadow-lg transition duration-200">
                    Añadir Gasto
                </button>
            </div>
        </div>

        <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-md">
            <h2 class="text-xl font-bold text-gray-700 mb-4">Registro de Transacciones</h2>
            <div id="transaction-list" class="list-container space-y-3">
                <p class="text-center text-gray-500">No hay transacciones registradas para este mes.</p>
            </div>
        </div>

        <div id="message-container" class="fixed top-4 right-4 w-full max-w-xs space-y-2">
            </div>

    </div>

    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>

    <script>
        // --- 1. Configuración de Firebase ---
        // DEBES REEMPLAZAR ESTO CON TUS CREDENCIALES REALES
        const firebaseConfig = {
            apiKey: "TU_API_KEY",
            authDomain: "TU_AUTH_DOMAIN",
            projectId: "TU_PROJECT_ID",
            storageBucket: "TU_STORAGE_BUCKET",
            messagingSenderId: "TU_MESSAGING_SENDER_ID",
            appId: "TU_APP_ID"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Referencia a Firestore para facilitar el uso
        const transactionsRef = db.collection('transactions');

        // Referencia al div de estado de autenticación
        const authStatusElement = document.getElementById('auth-status');

        // --- 2. Funciones de UI y Mensajes ---
        window.showMessage = (message, type = 'info') => {
            const container = document.getElementById('message-container');
            const alert = document.createElement('div');
            let bgColor;
            let textColor;

            if (type === 'success') {
                bgColor = 'bg-green-500';
                textColor = 'text-white';
            } else if (type === 'error') {
                bgColor = 'bg-red-500';
                textColor = 'text-white';
            } else {
                bgColor = 'bg-blue-500';
                textColor = 'text-white';
            }

            alert.className = `${bgColor} ${textColor} p-4 rounded-md shadow-xl transition-opacity duration-300`;
            alert.textContent = message;

            container.prepend(alert);

            setTimeout(() => {
                alert.classList.add('opacity-0');
                alert.addEventListener('transitionend', () => alert.remove());
            }, 5000);
        };

        // --- 3. Variables de UI y Lógica de Arranque ---
        // Declaramos las variables DENTRO de la función de autenticación para asegurar que existen
        let incomeNameInput, incomeAmountInput, expenseNameInput, expenseAmountInput;
        let totalIncomeElement, totalExpensesElement, netBalanceElement, transactionListElement, monthFilterElement;
        
        // --- 4. Inicialización de la Aplicación ---
        
        // Esta función se ejecuta una vez que Firebase ha comprobado el estado del usuario
        function initApp(user) {
            
            if (user) {
                // El usuario está logueado
                authStatusElement.textContent = `Sesión iniciada como: ${user.email}`;

                // --- Referencias de Elementos de UI (Líneas 92-95 corregidas) ---
                // Aquí se garantiza que los elementos del DOM ya existen.
                incomeNameInput = document.getElementById('income-name');
                incomeAmountInput = document.getElementById('income-amount');
                expenseNameInput = document.getElementById('expense-name');
                expenseAmountInput = document.getElementById('expense-amount');

                totalIncomeElement = document.getElementById('total-income');
                totalExpensesElement = document.getElementById('total-expenses');
                netBalanceElement = document.getElementById('net-balance');
                transactionListElement = document.getElementById('transaction-list');
                monthFilterElement = document.getElementById('month-filter');

                // Lógica de escucha de cambios en la base de datos (firestore)
                setupFirestoreListener(user.uid);
                
                // Lógica para añadir y limpiar transacciones
                setupTransactionFunctions();


            } else {
                // No hay usuario, inicia sesión anónimamente si lo deseas
                authStatusElement.textContent = "Usuario no autenticado. Iniciando sesión anónima...";
                auth.signInAnonymously()
                    .catch(error => {
                        window.showMessage(`Error de autenticación: ${error.message}`, 'error');
                        authStatusElement.textContent = "Error al iniciar sesión anónima.";
                    });
            }
        }
        
        // Ejecutamos la función de inicialización cuando el estado de autenticación cambia
        auth.onAuthStateChanged(initApp);
        
        // --- 5. Lógica de Transacciones (Mover fuera de initApp si es necesario, pero referenciar variables globales) ---
        
        function addTransaction(name, amount, type, userId) {
            if (!name || isNaN(amount) || amount <= 0) {
                window.showMessage("Por favor, introduce un nombre y un monto válido.", 'error');
                return;
            }
            
            const transactionData = {
                name: name.trim(),
                amount: amount,
                type: type, // 'income' o 'expense'
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                month: new Date().toISOString().substring(0, 7), // YYYY-MM
                userId: userId // ID del usuario para seguridad
            };
            
            // Si el error 400 persiste, es aquí. Revisar Reglas de Firebase
            transactionsRef.add(transactionData)
                .then(() => {
                    
                    // Limpiar campos y mostrar éxito (Líneas 344-349 CORREGIDAS)
                    if (type === 'income') {
                        // Estas líneas DEBEN usar las minúsculas según tu declaración
                        incomeNameInput.value = '';  // LÍNEA 344
                        incomeAmountInput.value = ''; // LÍNEA 345
                        window.showMessage("Ingreso registrado con éxito.", 'success');
                    } else {
                        // Estas líneas DEBEN usar las minúsculas según tu declaración
                        expenseNameInput.value = ''; // LÍNEA 348
                        expenseAmountInput.value = ''; // LÍNEA 349
                        window.showMessage("Gasto registrado con éxito.", 'success');
                    }
                })
                .catch(e => {
                    console.error(`Error al añadir ${type}: `, e);
                    window.showMessage(`Error al guardar el ${type}. Revisa la consola.`, 'error');
                });
        }
        
        function setupTransactionFunctions() {
            // Asigna las funciones globales para los botones de click
            window.addIncome = () => {
                const user = auth.currentUser;
                if (user) {
                    addTransaction(incomeNameInput.value.trim(), parseFloat(incomeAmountInput.value), 'income', user.uid);
                } else {
                    window.showMessage("Error: No se pudo verificar la autenticación.", 'error');
                }
            };

            window.addExpense = () => {
                const user = auth.currentUser;
                if (user) {
                    addTransaction(expenseNameInput.value.trim(), parseFloat(expenseAmountInput.value), 'expense', user.uid);
                } else {
                    window.showMessage("Error: No se pudo verificar la autenticación.", 'error');
                }
            };
        }


        // El resto de tus funciones (renderizarTransacciones, actualizarTotales, setupFirestoreListener)
        // DEBEN ir aquí, referenciando las variables globales.
        
        // ... (Tu código para dibujar listas y actualizar totales) ...
        
    </script>
</body>
</html>
