<script type="module">
ย ย // --- CONFIGURACIรN SIMPLIFICADA SIN FIREBASE ---
ย ย ย ย
ย ย // Variables globales
ย ย let userId = 'usuario-demo-' + Math.random().toString(36).substr(2, 9);
ย ย let allIncomes = [];
ย ย let allExpenses = [];
ย ย let currentIncomes = [];
ย ย let currentExpenses = [];

ย ย // Referencias de elementos
ย ย const elements = {
ย ย ย ย incomeName: document.getElementById('income-name'),
ย ย ย ย incomeAmount: document.getElementById('income-amount'),
ย ย ย ย expenseName: document.getElementById('expense-name'),
ย ย ย ย expenseAmount: document.getElementById('expense-amount'),
ย ย ย ย totalIncome: document.getElementById('total-income'),
ย ย ย ย totalExpense: document.getElementById('total-expense'),
ย ย ย ย netBalance: document.getElementById('net-balance'),
ย ย ย ย incomeList: document.getElementById('income-list'),
ย ย ย ย expenseList: document.getElementById('expense-list'),
ย ย ย ย userIdDisplay: document.getElementById('user-id-display'),
ย ย ย ย messageBox: document.getElementById('message-box'),
ย ย ย ย monthFilter: document.getElementById('month-filter'),
ย ย ย ย analyzeButton: document.getElementById('analyze-button'),
ย ย ย ย analysisResult: document.getElementById('analysis-result'),
ย ย ย ย incomeCount: document.getElementById('income-count'),
ย ย ย ย expenseCount: document.getElementById('expense-count'),
ย ย ย ย addIncomeBtn: document.getElementById('add-income-btn'),
ย ย ย ย addExpenseBtn: document.getElementById('add-expense-btn'),
ย ย ย ย exportBtn: document.getElementById('export-btn')
ย ย };

ย ย // Utilidades
ย ย window.showMessage = showMessage; // Hacer showMessage global para el botรณn de cerrar
ย ย window.deleteTransaction = deleteTransaction; // Hacer deleteTransaction global para los botones de eliminar
ย ย 
ย ย function showMessage(message, type = 'error') {
ย ย ย ย const icon = type === 'success' ? 'โ' : type === 'warning' ? 'โ๏ธ' : 'โ';
ย ย ย ย const bgColor = type === 'success' ? 'bg-green-50' : type === 'warning' ? 'bg-yellow-50' : 'bg-red-50';
ย ย ย ย const textColor = type === 'success' ? 'text-green-800' : type === 'warning' ? 'text-yellow-800' : 'text-red-800';
ย ย ย ย const borderColor = type === 'success' ? 'border-green-200' : type === 'warning' ? 'border-yellow-200' : 'border-red-200';
ย ย ย ย ย ย
ย ย ย ย elements.messageBox.innerHTML = `
ย ย ย ย ย ย <div class="flex items-center justify-between p-4 rounded-lg ${bgColor} ${textColor} border ${borderColor}">
ย ย ย ย ย ย ย ย <div class="flex items-center">
ย ย ย ย ย ย ย ย ย ย <span class="text-lg mr-3">${icon}</span>
ย ย ย ย ย ย ย ย ย ย <span class="font-medium">${message}</span>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <button onclick="this.parentElement.parentElement.classList.add('hidden')"ย
ย ย ย ย ย ย ย ย ย ย ย ย class="text-gray-400 hover:text-gray-600">
ย ย ย ย ย ย ย ย ย ย โ
ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย </div>
ย ย ย ย `;
ย ย ย ย elements.messageBox.classList.remove('hidden');
ย ย ย ย setTimeout(() => {
ย ย ย ย ย ย elements.messageBox.classList.add('hidden');
ย ย ย ย }, 5000);
ย ย }

ย ย function formatCurrency(amount) {
ย ย ย ย return new Intl.NumberFormat('es-PE', {
ย ย ย ย ย ย style: 'currency',
ย ย ย ย ย ย currency: 'PEN'
ย ย ย ย }).format(amount);
ย ย }

ย ย // Lรณgica principal
ย ย function handleDataChange() {
ย ย ย ย const selectedValue = elements.monthFilter.value;
ย ย ย ย let totalIncome = 0;
ย ย ย ย let totalExpenses = 0;

ย ย ย ย currentIncomes = [];
ย ย ย ย currentExpenses = [];

ย ย ย ย // Procesar ingresos
ย ย ย ย elements.incomeList.innerHTML = '';
ย ย ย ย const filteredIncomes = selectedValue === 'all' ? allIncomes :ย
ย ย ย ย ย ย allIncomes.filter(income => {
ย ย ย ย ย ย ย ย const date = new Date(income.timestamp);
ย ย ย ย ย ย ย ย const month = date.getMonth() + 1;
ย ย ย ย ย ย ย ย const year = date.getFullYear();
ย ย ย ย ย ย ย ย return `${String(month).padStart(2, '0')}-${year}` === selectedValue;
ย ย ย ย ย ย });
ย ย ย ย ย ย 
ย ย ย ย filteredIncomes.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // Ordenar por fecha

ย ย ย ย if (filteredIncomes.length === 0) {
ย ย ย ย ย ย elements.incomeList.innerHTML = `
ย ย ย ย ย ย ย ย <div class="text-center py-8 text-gray-400">
ย ย ย ย ย ย ย ย ย ย <div class="text-4xl mb-2">๐ฐ</div>
ย ย ย ย ย ย ย ย ย ย <p class="text-sm">No hay ingresos registrados</p>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย `;
ย ย ย ย } else {
ย ย ย ย ย ย filteredIncomes.forEach(income => {
ย ย ย ย ย ย ย ย totalIncome += income.amount;
ย ย ย ย ย ย ย ย currentIncomes.push(income);
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย const li = document.createElement('li');
ย ย ย ย ย ย ย ย li.className = 'flex justify-between items-center p-4 bg-green-50 border border-green-200 rounded-lg mb-3 transition-all duration-200 hover:scale-[1.02]';
ย ย ย ย ย ย ย ย li.innerHTML = `
ย ย ย ย ย ย ย ย ย ย <div class="flex-1">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex items-center justify-between">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span class="font-semibold text-gray-800">${income.name}</span>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span class="text-lg font-bold text-green-600">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ${formatCurrency(income.amount)}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </span>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex items-center justify-between mt-2">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span class="text-xs text-gray-500">${new Date(income.timestamp).toLocaleDateString('es-PE')}</span>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="deleteTransaction('${income.id}', 'income')"ย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย class="text-gray-400 hover:text-red-500 transition-colors duration-200 p-1 rounded"
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย title="Eliminar">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </svg>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย `;
ย ย ย ย ย ย ย ย elements.incomeList.appendChild(li);
ย ย ย ย ย ย });
ย ย ย ย }

ย ย ย ย // Procesar gastos
ย ย ย ย elements.expenseList.innerHTML = '';
ย ย ย ย const filteredExpenses = selectedValue === 'all' ? allExpenses :ย
ย ย ย ย ย ย allExpenses.filter(expense => {
ย ย ย ย ย ย ย ย const date = new Date(expense.timestamp);
ย ย ย ย ย ย ย ย const month = date.getMonth() + 1;
ย ย ย ย ย ย ย ย const year = date.getFullYear();
ย ย ย ย ย ย ย ย return `${String(month).padStart(2, '0')}-${year}` === selectedValue;
ย ย ย ย ย ย });
ย ย ย ย ย ย 
ย ย ย ย filteredExpenses.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // Ordenar por fecha

ย ย ย ย if (filteredExpenses.length === 0) {
ย ย ย ย ย ย elements.expenseList.innerHTML = `
ย ย ย ย ย ย ย ย <div class="text-center py-8 text-gray-400">
ย ย ย ย ย ย ย ย ย ย <div class="text-4xl mb-2">๐ธ</div>
ย ย ย ย ย ย ย ย ย ย <p class="text-sm">No hay gastos registrados</p>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย `;
ย ย ย ย } else {
ย ย ย ย ย ย filteredExpenses.forEach(expense => {
ย ย ย ย ย ย ย ย totalExpenses += expense.amount;
ย ย ย ย ย ย ย ย currentExpenses.push(expense);
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย const li = document.createElement('li');
ย ย ย ย ย ย ย ย li.className = 'flex justify-between items-center p-4 bg-red-50 border border-red-200 rounded-lg mb-3 transition-all duration-200 hover:scale-[1.02]';
ย ย ย ย ย ย ย ย li.innerHTML = `
ย ย ย ย ย ย ย ย ย ย <div class="flex-1">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex items-center justify-between">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span class="font-semibold text-gray-800">${expense.name}</span>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span class="text-lg font-bold text-red-600">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ${formatCurrency(expense.amount)}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </span>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex items-center justify-between mt-2">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span class="text-xs text-gray-500">${new Date(expense.timestamp).toLocaleDateString('es-PE')}</span>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="deleteTransaction('${expense.id}', 'expense')"ย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย class="text-gray-400 hover:text-red-500 transition-colors duration-200 p-1 rounded"
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย title="Eliminar">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </svg>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย `;
ย ย ย ย ย ย ย ย elements.expenseList.appendChild(li);
ย ย ย ย ย ย });
ย ย ย ย }

ย ย ย ย // Actualizar estadรญsticas
ย ย ย ย elements.totalIncome.textContent = formatCurrency(totalIncome);
ย ย ย ย elements.totalExpense.textContent = formatCurrency(totalExpenses);
ย ย ย ย elements.netBalance.textContent = formatCurrency(totalIncome - totalExpenses);

ย ย ย ย // Actualizar contadores
ย ย ย ย elements.incomeCount.textContent = `${filteredIncomes.length} registros`;
ย ย ย ย elements.expenseCount.textContent = `${filteredExpenses.length} registros`;

ย ย ย ย // Actualizar estilo del balance neto
ย ย ย ย const balance = totalIncome - totalExpenses;
ย ย ย ย if (balance > 0) {
ย ย ย ย ย ย elements.netBalance.className = 'text-3xl font-bold text-green-600';
ย ย ย ย } else if (balance < 0) {
ย ย ย ย ย ย elements.netBalance.className = 'text-3xl font-bold text-red-600';
ย ย ย ย } else {
ย ย ย ย ย ย elements.netBalance.className = 'text-3xl font-bold text-gray-600';
ย ย ย ย }
ย ย }

ย ย // Poblar filtro de meses
ย ย function populateMonthFilter() {
ย ย ย ย const today = new Date();
ย ย ย ย const currentMonth = today.getMonth();
ย ย ย ย const currentYear = today.getFullYear();
ย ย ย ย const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",ย
ย ย ย ย ย ย ย ย ย ย ย ย ย "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

ย ย ย ย let optionsHTML = `<option value="all">๐ Todos los meses</option>`;

ย ย ย ย for (let i = 0; i < 12; i++) {
ย ย ย ย ย ย // Calcula el mes y aรฑo retrocediendo i meses
ย ย ย ย ย ย let date = new Date(currentYear, currentMonth - i, 1);
ย ย ย ย ย ย const month = date.getMonth();
ย ย ย ย ย ย const year = date.getFullYear();
ย ย ย ย ย ย const value = `${String(month + 1).padStart(2, '0')}-${year}`;
ย ย ย ย ย ย const label = `${monthNames[month]} ${year}`;
ย ย ย ย ย ย const emoji = i === 0 ? '๐ฏ' : i < 3 ? '๐' : '๐';
ย ย ย ย ย ย 
ย ย ย ย ย ย optionsHTML += `<option value="${value}" ${i === 0 ? 'selected' : ''}>${emoji} ${label}</option>`;
ย ย ย ย }
ย ย ย ย ย ย
ย ย ย ย elements.monthFilter.innerHTML = optionsHTML;
ย ย }

ย ย // Funciones CRUD
ย ย function addTransaction(name, amount, type) {
ย ย ย ย if (!name || isNaN(amount) || amount <= 0) {
ย ย ย ย ย ย showMessage("Por favor, ingresa un nombre y cantidad vรกlida (mayor a 0)");
ย ย ย ย ย ย return;
ย ย ย ย }

ย ย ย ย const transaction = {
ย ย ย ย ย ย id: Date.now().toString() + Math.random().toString(36).substr(2, 5),
ย ย ย ย ย ย name: name.trim(),
ย ย ย ย ย ย amount: parseFloat(amount),
ย ย ย ย ย ย timestamp: new Date().toISOString()
ย ย ย ย };

ย ย ย ย if (type === 'income') {
ย ย ย ย ย ย allIncomes.push(transaction);
ย ย ย ย ย ย elements.incomeName.value = '';
ย ย ย ย ย ย elements.incomeAmount.value = '';
ย ย ย ย ย ย showMessage('Ingreso registrado exitosamente', 'success');
ย ย ย ย } else {
ย ย ย ย ย ย allExpenses.push(transaction);
ย ย ย ย ย ย elements.expenseName.value = '';
ย ย ย ย ย ย elements.expenseAmount.value = '';
ย ย ย ย ย ย showMessage('Gasto registrado exitosamente', 'success');
ย ย ย ย }

ย ย ย ย handleDataChange();
ย ย }

ย ย function deleteTransaction(id, type) {
ย ย ย ย if (type === 'income') {
ย ย ย ย ย ย allIncomes = allIncomes.filter(income => income.id !== id);
ย ย ย ย ย ย showMessage('Ingreso eliminado', 'success');
ย ย ย ย } else {
ย ย ย ย ย ย allExpenses = allExpenses.filter(expense => expense.id !== id);
ย ย ย ย ย ย showMessage('Gasto eliminado', 'success');
ย ย ย ย }
ย ย ย ย handleDataChange();
ย ย }

ย ย // Funciones adicionales
ย ย function analyzeFinancesWithGemini() {
ย ย ย ย elements.analyzeButton.disabled = true;
ย ย ย ย elements.analyzeButton.innerHTML = '๐ Analizando...';
ย ย ย ย elements.analysisResult.innerHTML = `
ย ย ย ย ย ย <div class="text-center py-8">
ย ย ย ย ย ย ย ย <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-4"></div>
ย ย ย ย ย ย ย ย <p class="text-gray-500">Generando anรกlisis con IA...</p>
ย ย ย ย ย ย </div>
ย ย ย ย `;

ย ย ย ย setTimeout(() => {
ย ย ย ย ย ย // Extraer montos numรฉricos
ย ย ย ย ย ย const totalIncomeText = elements.totalIncome.textContent.replace('S/', '').replace(',', '').trim();
ย ย ย ย ย ย const totalExpenseText = elements.totalExpense.textContent.replace('S/', '').replace(',', '').trim();

ย ย ย ย ย ย const totalIncome = parseFloat(totalIncomeText) || 0;
ย ย ย ย ย ย const totalExpense = parseFloat(totalExpenseText) || 0;
ย ย ย ย ย ย const balance = totalIncome - totalExpense;

ย ย ย ย ย ย let analysis = '';
ย ย ย ย ย ย if (totalIncome === 0 && totalExpense === 0) {
ย ย ย ย ย ย ย ย analysis = `
ย ย ย ย ย ย ย ย ย ย <div class="bg-gray-50 border border-gray-200 rounded-lg p-6">
ย ย ย ย ย ย ย ย ย ย ย ย <h4 class="font-semibold text-gray-800 mb-3">๐ง Sin datos para analizar</h4>
ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-gray-700 text-sm">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย Por favor, registra algunos ingresos y gastos para que la IA pueda generar un anรกlisis.
ย ย ย ย ย ย ย ย ย ย ย ย </p>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย `;
ย ย ย ย ย ย } else if (balance > 0) {
ย ย ย ย ย ย ย ย const percent = totalIncome > 0 ? ((balance / totalIncome) * 100).toFixed(1) : '0.0';
ย ย ย ย ย ย ย ย analysis = `
ย ย ย ย ย ย ย ย ย ย <div class="bg-green-50 border border-green-200 rounded-lg p-6">
ย ย ย ย ย ย ย ย ย ย ย ย <h4 class="font-semibold text-green-800 mb-3">๐ ยกExcelente gestiรณn financiera!</h4>
ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-green-700 text-sm mb-3">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย Tienes un superรกvit de <strong>${formatCurrency(balance)}</strong> este mes.ย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย Esto representa un <strong>${percent}%</strong> de ahorro sobre tus ingresos.
ย ย ย ย ย ย ย ย ย ย ย ย </p>
ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-green-700 text-sm">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ๐ก <strong>Consejo:</strong> Considera invertir una parte de este excedenteย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย para hacer crecer tu patrimonio.
ย ย ย ย ย ย ย ย ย ย ย ย </p>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย `;
ย ย ย ย ย ย } else if (balance < 0) {
ย ย ย ย ย ย ย ย const percent = totalIncome > 0 ? ((Math.abs(balance) / totalIncome) * 100).toFixed(1) : '100.0';
ย ย ย ย ย ย ย ย analysis = `
ย ย ย ย ย ย ย ย ย ย <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
ย ย ย ย ย ย ย ย ย ย ย ย <h4 class="font-semibold text-yellow-800 mb-3">โ๏ธ Atenciรณn necesaria</h4>
ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-yellow-700 text-sm mb-3">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย Tienes un dรฉficit de <strong>${formatCurrency(Math.abs(balance))}</strong> este mes.ย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย Tus gastos superan tus ingresos en un <strong>${percent}%</strong>.
ย ย ย ย ย ย ย ย ย ย ย ย </p>
ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-yellow-700 text-sm">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ๐ก <strong>Consejo:</strong> Revisa tus gastos recurrentes y consideraย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย reducir gastos no esenciales para equilibrar tu presupuesto.
ย ย ย ย ย ย ย ย ย ย ย ย </p>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย `;
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย analysis = `
ย ย ย ย ย ย ย ย ย ย <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
ย ย ย ย ย ย ย ย ย ย ย ย <h4 class="font-semibold text-blue-800 mb-3">โ๏ธ Balance equilibrado</h4>
ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-blue-700 text-sm mb-3">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย Tus ingresos y gastos estรกn perfectamente equilibrados este mes.ย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย No tienes superรกvit ni dรฉficit.
ย ย ย ย ย ย ย ย ย ย ย ย </p>
ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-blue-700 text-sm">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ๐ก <strong>Consejo:</strong> Intenta generar un pequeรฑo superรกvitย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย cada mes para crear un fondo de emergencia.
ย ย ย ย ย ย ย ย ย ย ย ย </p>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย `;
ย ย ย ย ย ย }

ย ย ย ย ย ย elements.analysisResult.innerHTML = analysis;
ย ย ย ย ย ย elements.analyzeButton.disabled = false;
ย ย ย ย ย ย elements.analyzeButton.innerHTML = '๐ค Generar Anรกlisis con IA';
ย ย ย ย }, 2000);
ย ย }

ย ย function exportDataToCSV() {
ย ย ย ย if (currentIncomes.length === 0 && currentExpenses.length === 0) {
ย ย ย ย ย ย showMessage('No hay datos para exportar en el periodo actual', 'warning');
ย ย ย ย ย ย return;
ย ย ย ย }

ย ย ย ย const allTransactions = [
ย ย ย ย ย ย ...currentIncomes.map(t => ({ ...t, type: 'INGRESO' })),
ย ย ย ย ย ย ...currentExpenses.map(t => ({ ...t, type: 'GASTO' }))
ย ย ย ย ].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp)); // Ordenar por fecha

ย ย ย ย const headers = ['Fecha', 'Tipo', 'Descripcion', 'Monto (S/)'];
ย ย ย ย let csvContent = headers.join(',') + '\n';

ย ย ย ย allTransactions.forEach(transaction => {
ย ย ย ย ย ย const row = [
ย ย ย ย ย ย ย ย new Date(transaction.timestamp).toLocaleDateString('es-PE'),
ย ย ย ย ย ย ย ย transaction.type,
ย ย ย ย ย ย ย ย // Escapar comillas y evitar separadores en la descripciรณn
ย ย ย ย ย ย ย ย `"${transaction.name.replace(/"/g, '""')}"`, 
ย ย ย ย ย ย ย ย transaction.amount.toFixed(2)
ย ย ย ย ย ย ];
ย ย ย ย ย ย csvContent += row.join(',') + '\n';
ย ย ย ย });

ย ย ย ย const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' }); // Agregar BOM para compatibilidad con tildes en Excel
ย ย ย ย const url = URL.createObjectURL(blob);
ย ย ย ย const a = document.createElement('a');
ย ย ย ย a.href = url;
ย ย ย ย const selectedMonth = elements.monthFilter.options[elements.monthFilter.selectedIndex].text.replace('๐ฏ', '').replace('๐', '').replace('๐', '').trim();
ย ย ย ย a.download = `Reporte_Finanzas_${selectedMonth.replace(/ /g, '_')}.csv`;
ย ย ย ย document.body.appendChild(a);
ย ย ย ย a.click();
ย ย ย ย document.body.removeChild(a);
ย ย ย ย URL.revokeObjectURL(url);
ย ย ย ย showMessage('Datos exportados a CSV exitosamente', 'success');
ย ย }
ย ย 
ย ย 
ย ย // --- SIMULACIรN DE DATOS Y EVENTOS ---
ย ย 
ย ย function loadInitialData() {
ย ย ย ย elements.userIdDisplay.textContent = `๐ค ${userId}`;

ย ย ย ย const today = new Date();
ย ย ย ย const currentMonthYear = `${String(today.getMonth() + 1).padStart(2, '0')}-${today.getFullYear()}`;
ย ย ย ย 
ย ย ย ย // Datos de muestra para el mes actual
ย ย ย ย const sampleIncomes = [
ย ย ย ย ย ย { id: 'inc1', name: 'Salario Principal', amount: 4500.00, timestamp: new Date(today.getFullYear(), today.getMonth(), 15).toISOString() },
ย ย ย ย ย ย { id: 'inc2', name: 'Venta de Servicios', amount: 850.50, timestamp: new Date(today.getFullYear(), today.getMonth(), 20).toISOString() }
ย ย ย ย ];

ย ย ย ย const sampleExpenses = [
ย ย ย ย ย ย { id: 'exp1', name: 'Alquiler', amount: 1500.00, timestamp: new Date(today.getFullYear(), today.getMonth(), 1).toISOString() },
ย ย ย ย ย ย { id: 'exp2', name: 'Supermercado', amount: 450.70, timestamp: new Date(today.getFullYear(), today.getMonth(), 5).toISOString() },
ย ย ย ย ย ย { id: 'exp3', name: 'Servicio de Internet', amount: 100.00, timestamp: new Date(today.getFullYear(), today.getMonth(), 10).toISOString() },
ย ย ย ย ย ย { id: 'exp4', name: 'Transporte', amount: 120.00, timestamp: new Date(today.getFullYear(), today.getMonth(), 18).toISOString() }
ย ย ย ย ];
ย ย ย ย 
ย ย ย ย // Datos de muestra para el mes anterior (para probar el filtro)
ย ย ย ย const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
ย ย ย ย const lastMonthIncomes = [
ย ย ย ย ย ย { id: 'inc3', name: 'Salario Anterior', amount: 4000.00, timestamp: new Date(lastMonth.getFullYear(), lastMonth.getMonth(), 15).toISOString() }
ย ย ย ย ];
ย ย ย ย 
ย ย ย ย allIncomes.push(...sampleIncomes, ...lastMonthIncomes);
ย ย ย ย allExpenses.push(...sampleExpenses);
ย ย ย ย 
ย ย ย ย populateMonthFilter();
ย ย ย ย handleDataChange();
ย ย }

ย ย function setupEventListeners() {
ย ย ย ย elements.addIncomeBtn.addEventListener('click', () => {
ย ย ย ย ย ย addTransaction(elements.incomeName.value, elements.incomeAmount.value, 'income');
ย ย ย ย });
ย ย ย ย 
ย ย ย ย elements.addExpenseBtn.addEventListener('click', () => {
ย ย ย ย ย ย addTransaction(elements.expenseName.value, elements.expenseAmount.value, 'expense');
ย ย ย ย });

ย ย ย ย elements.monthFilter.addEventListener('change', handleDataChange);
ย ย ย ย elements.analyzeButton.addEventListener('click', analyzeFinancesWithGemini);
ย ย ย ย elements.exportBtn.addEventListener('click', exportDataToCSV);
ย ย }

ย ย // Inicializaciรณn de la aplicaciรณn
ย ย document.addEventListener('DOMContentLoaded', () => {
ย ย ย ย loadInitialData();
ย ย ย ย setupEventListeners();
ย ย });
ย ย 
ย ย // Mantenemos las funciones globales para los onclicks en el HTML
ย ย window.deleteTransaction = deleteTransaction;
ย ย window.showMessage = showMessage;

</script>


