<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Ingresos y Gastos</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí∞</text></svg>">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .list-container {
            max-height: 300px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 transparent;
        }
        .list-container::-webkit-scrollbar {
            width: 6px;
        }
        .list-container::-webkit-scrollbar-track {
            background: transparent;
        }
        .list-container::-webkit-scrollbar-thumb {
            background-color: #cbd5e0;
            border-radius: 3px;
        }
        .stat-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
    </style>
</head>
<body class="min-h-screen py-8 px-4">
    <div class="max-w-6xl mx-auto">
        <div class="glass-card rounded-2xl p-8 mb-8 text-center">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">
                üí∞ Control Financiero Personal
            </h1>
            <p class="text-gray-600 mb-4">Gestiona tus ingresos y gastos en Soles Peruanos</p>
            <div class="flex items-center justify-center space-x-4 text-sm text-gray-500">
                <span id="user-id-display" class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full">
                    ‚òÅÔ∏è Conectado (Firestore)
                </span>
                <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full">
                    üí≥ Soles (PEN)
                </span>
            </div>
        </div>

        <div id="message-box" class="hidden mb-6"></div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="stat-card bg-white rounded-2xl p-6 shadow-lg border border-green-200">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Total Ingresos</h3>
                    <span class="text-2xl">üì•</span>
                </div>
                <div class="text-3xl font-bold text-green-600 mb-2" id="total-income">S/ 0.00</div>
                <div class="text-xs text-gray-500">Ingresos del periodo seleccionado</div>
            </div>

            <div class="stat-card bg-white rounded-2xl p-6 shadow-lg border border-red-200">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Total Gastos</h3>
                    <span class="text-2xl">üì§</span>
                </div>
                <div class="text-3xl font-bold text-red-600 mb-2" id="total-expense">S/ 0.00</div>
                <div class="text-xs text-gray-500">Gastos del periodo seleccionado</div>
            </div>

            <div class="stat-card bg-white rounded-2xl p-6 shadow-lg border border-indigo-200">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Balance Neto</h3>
                    <span class="text-2xl">‚öñÔ∏è</span>
                </div>
                <div class="text-3xl font-bold text-gray-600 mb-2" id="net-balance">S/ 0.00</div>
                <div class="text-xs text-gray-500">Resultado financiero neto</div>
            </div>
        </div>

        <div class="glass-card rounded-2xl p-6 mb-8">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-1">üìä Filtro de Periodo</h3>
                    <p class="text-sm text-gray-600">Selecciona el mes que deseas visualizar</p>
                </div>
                <select id="month-filter" 
                        class="bg-white border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 min-w-[200px]">
                </select>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="glass-card rounded-2xl p-6 border border-green-200">
                <div class="flex items-center mb-6">
                    <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                        <span class="text-xl">üíπ</span>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold text-gray-800">Agregar Ingreso</h3>
                        <p class="text-sm text-gray-600">Registra nuevos ingresos</p>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Descripci√≥n</label>
                        <input type="text" id="income-name" placeholder="Ej: Salario, Ventas, Bonificaci√≥n"
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Monto (S/)</label>
                        <input type="number" id="income-amount" placeholder="0.00" step="0.01" min="0.01"
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500">
                    </div>
                    <button id="add-income-btn"
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-xl transition-colors duration-200 flex items-center justify-center">
                        <span class="mr-2">‚ûï</span> Agregar Ingreso
                    </button>
                </div>
            </div>

            <div class="glass-card rounded-2xl p-6 border border-red-200">
                <div class="flex items-center mb-6">
                    <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center mr-3">
                        <span class="text-xl">üìâ</span>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold text-gray-800">Agregar Gasto</h3>
                        <p class="text-sm text-gray-600">Registra nuevos gastos</p>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Descripci√≥n</label>
                        <input type="text" id="expense-name" placeholder="Ej: Alquiler, Comida, Transporte"
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Monto (S/)</label>
                        <input type="number" id="expense-amount" placeholder="0.00" step="0.01" min="0.01"
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500">
                    </div>
                    <button id="add-expense-btn"
                            class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-xl transition-colors duration-200 flex items-center justify-center">
                        <span class="mr-2">‚ûñ</span> Agregar Gasto
                    </button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="glass-card rounded-2xl p-6 border border-indigo-200">
                <div class="flex items-center mb-6">
                    <div class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center mr-3">
                        <span class="text-xl">ü§ñ</span>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold text-gray-800">An√°lisis con IA</h3>
                        <p class="text-sm text-gray-600">Obt√©n insights inteligentes</p>
                    </div>
                </div>
                
                <button id="analyze-button"
                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-xl transition-colors duration-200 mb-4">
                    ü§ñ Generar An√°lisis con IA
                </button>
                
                <div id="analysis-result" class="bg-gray-50 rounded-xl p-4 min-h-[120px]">
                    <p class="text-gray-500 text-center italic py-4">
                        Haz clic en el bot√≥n para obtener un an√°lisis inteligente de tus finanzas
                    </p>
                </div>
            </div>

            <div class="glass-card rounded-2xl p-6 border border-gray-200">
                <div class="flex items-center mb-6">
                    <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center mr-3">
                        <span class="text-xl">üíæ</span>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold text-gray-800">Exportar Datos</h3>
                        <p class="text-sm text-gray-600">Guarda tu informaci√≥n</p>
                    </div>
                </div>
                
                <div class="space-y-3">
                    <button id="export-btn"
                            class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-4 rounded-xl transition-colors duration-200 flex items-center justify-center">
                        <span class="mr-2">üì•</span> Descargar CSV
                    </button>
                    <p class="text-xs text-gray-500 text-center">
                        Exporta tus transacciones a formato CSV compatible con Excel
                    </p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="glass-card rounded-2xl p-6 border border-green-200">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-semibold text-gray-800">üì• Historial de Ingresos</h3>
                    <span id="income-count" class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-medium">
                        0 registros
                    </span>
                </div>
                <ul id="income-list" class="list-container space-y-3">
                    </ul>
            </div>

            <div class="glass-card rounded-2xl p-6 border border-red-200">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-semibold text-gray-800">üì§ Historial de Gastos</h3>
                    <span id="expense-count" class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-sm font-medium">
                        0 registros
                    </span>
                </div>
                <ul id="expense-list" class="list-container space-y-3">
                    </ul>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURACI√ìN FIREBASE (REEMPLAZA ESTOS VALORES) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCil5A3PMp9-vUY5qTK_wbvUY5qTK_wbvUY5qTK_wb", // ¬°TU CLAVE EST√Å AQU√ç!
            authDomain: "TU_AUTH_DOMAIN_AQUI", // Ejem: "app-finanzas-1234.firebaseapp.com"
            projectId: "TU_PROJECT_ID_AQUI",     // Ejem: "app-finanzas-1234"
            storageBucket: "TU_STORAGE_BUCKET_AQUI",
            messagingSenderId: "TU_MESSAGING_SENDER_ID_AQUI",
            appId: "TU_APP_ID_AQUI"
        };

        // Inicializar Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore();
        // Usamos un ID fijo por ahora. En una app real, vendr√≠a de firebase.auth().currentUser.uid
        let userId = 'usuario_principal_peru'; 

        // Variables globales para los datos (se llenar√°n desde Firestore)
        let allIncomes = []; 
        let allExpenses = []; 
        let currentIncomes = []; // Datos filtrados
        let currentExpenses = []; // Datos filtrados
        // --- FIN CONFIGURACI√ìN FIREBASE ---


        // Referencias de elementos (Misma que antes)
        const elements = {
            incomeName: document.getElementById('income-name'),
            incomeAmount: document.getElementById('income-amount'),
            expenseName: document.getElementById('expense-name'),
            expenseAmount: document.getElementById('expense-amount'),
            totalIncome: document.getElementById('total-income'),
            totalExpense: document.getElementById('total-expense'),
            netBalance: document.getElementById('net-balance'),
            incomeList: document.getElementById('income-list'),
            expenseList: document.getElementById('expense-list'),
            userIdDisplay: document.getElementById('user-id-display'),
            messageBox: document.getElementById('message-box'),
            monthFilter: document.getElementById('month-filter'),
            analyzeButton: document.getElementById('analyze-button'),
            analysisResult: document.getElementById('analysis-result'),
            incomeCount: document.getElementById('income-count'),
            expenseCount: document.getElementById('expense-count'),
            addIncomeBtn: document.getElementById('add-income-btn'),
            addExpenseBtn: document.getElementById('add-expense-btn'),
            exportBtn: document.getElementById('export-btn')
        };

        // Utilidades (Mismas que antes)
        function showMessage(message, type = 'error') {
            const icon = type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ùå';
            const bgColor = type === 'success' ? 'bg-green-50' : type === 'warning' ? 'bg-yellow-50' : 'bg-red-50';
            const textColor = type === 'success' ? 'text-green-800' : type === 'warning' ? 'text-yellow-800' : 'text-red-800';
            const borderColor = type === 'success' ? 'border-green-200' : type === 'warning' ? 'border-yellow-200' : 'border-red-200';
            
            elements.messageBox.innerHTML = `
                <div class="flex items-center justify-between p-4 rounded-lg ${bgColor} ${textColor} border ${borderColor}">
                    <div class="flex items-center">
                        <span class="text-lg mr-3">${icon}</span>
                        <span class="font-medium">${message}</span>
                    </div>
                    <button onclick="this.parentElement.parentElement.classList.add('hidden')" 
                            class="text-gray-400 hover:text-gray-600">
                        ‚úï
                    </button>
                </div>
            `;
            elements.messageBox.classList.remove('hidden');
            setTimeout(() => {
                elements.messageBox.classList.add('hidden');
            }, 5000);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-PE', {
                style: 'currency',
                currency: 'PEN'
            }).format(amount);
        }

        // --- FUNCIONES CRUD CON FIREBASE ---

        // Funci√≥n para eliminar transacciones en Firestore
        window.deleteTransaction = async function(id, type) {
            const collectionName = type === 'income' ? 'incomes' : 'expenses';
            
            try {
                // La referencia en Firestore es: /users/{userId}/{collectionName}/{docId}
                await db.collection('users').doc(userId).collection(collectionName).doc(id).delete();
                showMessage(`${type === 'income' ? 'Ingreso' : 'Gasto'} eliminado exitosamente.`, 'success');
                // Alerta: La funci√≥n 'loadAndFilterData' se encargar√° de actualizar la vista
            } catch (error) {
                console.error("Error al eliminar la transacci√≥n:", error);
                showMessage(`Error al eliminar la transacci√≥n: ${error.message}`);
            }
        };

        // Funci√≥n para agregar transacciones en Firestore
        async function addTransaction(name, amount, type) {
            if (!name || isNaN(amount) || amount <= 0) {
                showMessage("Por favor, ingresa un nombre y cantidad v√°lida (mayor a 0)");
                return;
            }

            const collectionName = type === 'income' ? 'incomes' : 'expenses';
            
            const transactionData = {
                name: name.trim(),
                amount: parseFloat(amount),
                timestamp: firebase.firestore.Timestamp.fromDate(new Date()) // Usamos Timestamp de Firebase
            };

            try {
                // Agregar el documento: /users/{userId}/{collectionName}
                await db.collection('users').doc(userId).collection(collectionName).add(transactionData);

                if (type === 'income') {
                    elements.incomeName.value = '';
                    elements.incomeAmount.value = '';
                } else {
                    elements.expenseName.value = '';
                    elements.expenseAmount.value = '';
                }
                showMessage(`${type === 'income' ? 'Ingreso' : 'Gasto'} registrado exitosamente.`, 'success');

                // Alerta: La funci√≥n 'loadAndFilterData' se encargar√° de actualizar la vista
            } catch (error) {
                console.error("Error al a√±adir la transacci√≥n:", error);
                showMessage(`Error al a√±adir la transacci√≥n: ${error.message}`);
            }
        }
        
        // Funci√≥n principal que carga los datos desde Firebase y filtra
        async function loadAndFilterData() {
            try {
                // 1. Mostrar estado de carga
                elements.incomeList.innerHTML = `<li class="text-center py-4 text-gray-500">Cargando datos de Ingresos...</li>`;
                elements.expenseList.innerHTML = `<li class="text-center py-4 text-gray-500">Cargando datos de Gastos...</li>`;

                // 2. Cargar Ingresos
                const incomesSnapshot = await db.collection('users').doc(userId).collection('incomes').get();
                allIncomes = incomesSnapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data(),
                    // Convertir Timestamp de Firebase a objeto Date
                    timestamp: doc.data().timestamp ? doc.data().timestamp.toDate().toISOString() : new Date().toISOString()
                }));
                
                // 3. Cargar Gastos
                const expensesSnapshot = await db.collection('users').doc(userId).collection('expenses').get();
                allExpenses = expensesSnapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data(),
                    // Convertir Timestamp de Firebase a objeto Date
                    timestamp: doc.data().timestamp ? doc.data().timestamp.toDate().toISOString() : new Date().toISOString()
                }));
                
                // 4. Filtrar y Renderizar
                filterAndRenderData();

            } catch (error) {
                console.error("Error al cargar datos desde Firebase:", error);
                showMessage(`Error al cargar los datos: ${error.message}`, 'error');
                elements.incomeList.innerHTML = `<li class="text-center py-8 text-red-400">Error al conectar con la base de datos.</li>`;
                elements.expenseList.innerHTML = `<li class="text-center py-8 text-red-400">Error al conectar con la base de datos.</li>`;
            }
        }

        // --- L√ìGICA DE FILTRADO Y RENDERIZADO (Anteriormente handleDataChange) ---

        function filterAndRenderData() {
            const selectedValue = elements.monthFilter.value;
            let totalIncome = 0;
            let totalExpenses = 0;

            currentIncomes = [];
            currentExpenses = [];

            // --- PROCESAR INGRESOS ---
            elements.incomeList.innerHTML = '';
            const filteredIncomes = selectedValue === 'all' ? allIncomes : 
                allIncomes.filter(income => {
                    const date = new Date(income.timestamp);
                    const month = date.getMonth() + 1;
                    const year = date.getFullYear();
                    return `${String(month).padStart(2, '0')}-${year}` === selectedValue;
                });
                
            filteredIncomes.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (filteredIncomes.length === 0) {
                elements.incomeList.innerHTML = `
                    <li class="text-center py-8 text-gray-400">
                        <div class="text-4xl mb-2">üí∞</div>
                        <p class="text-sm">No hay ingresos registrados para este periodo</p>
                    </li>
                `;
            } else {
                filteredIncomes.forEach(income => {
                    totalIncome += income.amount;
                    currentIncomes.push(income);
                    
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center p-4 bg-green-50 border border-green-200 rounded-lg mb-3 transition-all duration-200 hover:scale-[1.02]';
                    
                    // Asegurar que el ID se pasa correctamente a deleteTransaction
                    const safeId = income.id;
                    
                    li.innerHTML = `
                        <div class="flex-1">
                            <div class="flex items-center justify-between">
                                <span class="font-semibold text-gray-800">${income.name}</span>
                                <span class="text-lg font-bold text-green-600">
                                    ${formatCurrency(income.amount)}
                                </span>
                            </div>
                            <div class="flex items-center justify-between mt-2">
                                <span class="text-xs text-gray-500">${new Date(income.timestamp).toLocaleDateString('es-PE')}</span>
                                <button onclick="deleteTransaction('${safeId.replace(/'/g, "\\'")}', 'income')" 
                                        class="delete-btn text-gray-400 hover:text-red-500 transition-colors duration-200 p-1 rounded"
                                        title="Eliminar">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                    elements.incomeList.appendChild(li);
                });
            }

            // --- PROCESAR GASTOS ---
            elements.expenseList.innerHTML = '';
            const filteredExpenses = selectedValue === 'all' ? allExpenses : 
                allExpenses.filter(expense => {
                    const date = new Date(expense.timestamp);
                    const month = date.getMonth() + 1;
                    const year = date.getFullYear();
                    return `${String(month).padStart(2, '0')}-${year}` === selectedValue;
                });
                
            filteredExpenses.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (filteredExpenses.length === 0) {
                elements.expenseList.innerHTML = `
                    <li class="text-center py-8 text-gray-400">
                        <div class="text-4xl mb-2">üí∏</div>
                        <p class="text-sm">No hay gastos registrados para este periodo</p>
                    </li>
                `;
            } else {
                filteredExpenses.forEach(expense => {
                    totalExpenses += expense.amount;
                    currentExpenses.push(expense);
                    
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center p-4 bg-red-50 border border-red-200 rounded-lg mb-3 transition-all duration-200 hover:scale-[1.02]';
                    
                    // Asegurar que el ID se pasa correctamente a deleteTransaction
                    const safeId = expense.id;
                    
                    li.innerHTML = `
                        <div class="flex-1">
                            <div class="flex items-center justify-between">
                                <span class="font-semibold text-gray-800">${expense.name}</span>
                                <span class="text-lg font-bold text-red-600">
                                    ${formatCurrency(expense.amount)}
                                </span>
                            </div>
                            <div class="flex items-center justify-between mt-2">
                                <span class="text-xs text-gray-500">${new Date(expense.timestamp).toLocaleDateString('es-PE')}</span>
                                <button onclick="deleteTransaction('${safeId.replace(/'/g, "\\'")}', 'expense')" 
                                        class="delete-btn text-gray-400 hover:text-red-500 transition-colors duration-200 p-1 rounded"
                                        title="Eliminar">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                    elements.expenseList.appendChild(li);
                });
            }

            // Actualizar estad√≠sticas
            elements.totalIncome.textContent = formatCurrency(totalIncome);
            elements.totalExpense.textContent = formatCurrency(totalExpenses);
            
            const netBalance = totalIncome - totalExpenses;
            elements.netBalance.textContent = formatCurrency(netBalance);

            // Actualizar contadores
            elements.incomeCount.textContent = `${filteredIncomes.length} registros`;
            elements.expenseCount.textContent = `${filteredExpenses.length} registros`;

            // Actualizar estilo del balance neto
            if (netBalance > 0) {
                elements.netBalance.className = 'text-3xl font-bold text-green-600';
            } else if (netBalance < 0) {
                elements.netBalance.className = 'text-3xl font-bold text-red-600';
            } else {
                elements.netBalance.className = 'text-3xl font-bold text-gray-600';
            }
        }

        // Poblar filtro de meses (Misma que antes)
        function populateMonthFilter() {
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", 
                              "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

            let optionsHTML = `<option value="all">üìÖ Todos los meses</option>`;

            // Muestra los √∫ltimos 12 meses
            for (let i = 0; i < 12; i++) {
                let date = new Date(currentYear, currentMonth - i, 1);
                const month = date.getMonth();
                const year = date.getFullYear();
                const value = `${String(month + 1).padStart(2, '0')}-${year}`;
                const label = `${monthNames[month]} ${year}`;
                const emoji = i === 0 ? 'üéØ' : i < 3 ? 'üìä' : 'üìÖ';
                
                optionsHTML += `<option value="${value}" ${i === 0 ? 'selected' : ''}>${emoji} ${label}</option>`;
            }
                
            elements.monthFilter.innerHTML = optionsHTML;
        }

        // Funci√≥n para manejar el cambio en el filtro y disparar la re-renderizaci√≥n
        function handleFilterChange() {
            filterAndRenderData();
        }


        // --- Funciones Adicionales (Mismas que antes) ---

        function analyzeFinancesWithGemini() {
            elements.analyzeButton.disabled = true;
            elements.analyzeButton.innerHTML = 'üîÑ Analizando...';
            elements.analysisResult.innerHTML = `
                <div class="text-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-4"></div>
                    <p class="text-gray-500">Generando an√°lisis con IA...</p>
                </div>
            `;

            // Simulaci√≥n de respuesta de IA (2 segundos)
            setTimeout(() => {
                const totalIncomeText = elements.totalIncome.textContent.replace('S/', '').replace(/,/g, '').trim();
                const totalExpenseText = elements.totalExpense.textContent.replace('S/', '').replace(/,/g, '').trim();

                const totalIncome = parseFloat(totalIncomeText) || 0;
                const totalExpense = parseFloat(totalExpenseText) || 0;
                const balance = totalIncome - totalExpense;

                let analysis = '';
                if (totalIncome === 0 && totalExpense === 0) {
                    analysis = `
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-6">
                            <h4 class="font-semibold text-gray-800 mb-3">üßê Sin datos para analizar</h4>
                            <p class="text-gray-700 text-sm">
                                Por favor, registra algunos ingresos y gastos para que la IA pueda generar un an√°lisis.
                            </p>
                        </div>
                    `;
                } else if (balance > 0) {
                    const percent = totalIncome > 0 ? ((balance / totalIncome) * 100).toFixed(1) : '0.0';
                    analysis = `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                            <h4 class="font-semibold text-green-800 mb-3">üéâ ¬°Excelente gesti√≥n financiera!</h4>
                            <p class="text-green-700 text-sm mb-3">
                                Tienes un super√°vit de <strong>${formatCurrency(balance)}</strong> este mes. 
                                Esto representa un <strong>${percent}%</strong> de ahorro sobre tus ingresos.
                            </p>
                            <p class="text-green-700 text-sm">
                                üí° <strong>Consejo:</strong> Considera invertir una parte de este excedente 
                                para hacer crecer tu patrimonio.
                            </p>
                        </div>
                    `;
                } else if (balance < 0) {
                    const percent = totalIncome > 0 ? ((Math.abs(balance) / totalIncome) * 100).toFixed(1) : '100.0';
                    analysis = `
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
                            <h4 class="font-semibold text-yellow-800 mb-3">‚ö†Ô∏è Atenci√≥n necesaria</h4>
                            <p class="text-yellow-700 text-sm mb-3">
                                Tienes un d√©ficit de <strong>${formatCurrency(Math.abs(balance))}</strong> este mes. 
                                Tus gastos superan tus ingresos en un <strong>${percent}%</strong>.
                            </p>
                            <p class="text-yellow-700 text-sm">
                                üí° <strong>Consejo:</strong> Revisa tus gastos recurrentes y considera 
                                reducir gastos no esenciales para equilibrar tu presupuesto.
                            </p>
                        </div>
                    `;
                } else {
                    analysis = `
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                            <h4 class="font-semibold text-blue-800 mb-3">‚öñÔ∏è Balance equilibrado</h4>
                            <p class="text-blue-700 text-sm mb-3">
                                Tus ingresos y gastos est√°n perfectamente equilibrados este mes. 
                                No tienes super√°vit ni d√©ficit.
                            </p>
                            <p class="text-blue-700 text-sm">
                                üí° <strong>Consejo:</strong> Intenta generar un peque√±o super√°vit 
                                cada mes para crear un fondo de emergencia.
                            </p>
                        </div>
                    `;
                }

                elements.analysisResult.innerHTML = analysis;
                elements.analyzeButton.disabled = false;
                elements.analyzeButton.innerHTML = 'ü§ñ Generar An√°lisis con IA';
            }, 2000);
        }

        function exportDataToCSV() {
            // 1. Verificar si hay datos filtrados para exportar
            if (currentIncomes.length === 0 && currentExpenses.length === 0) {
                showMessage('No hay datos para exportar en el periodo seleccionado.', 'warning');
                return;
            }

            // 2. Preparar los datos
            const allCurrentTransactions = [
                ...currentIncomes.map(t => ({...t, type: 'Ingreso'})),
                ...currentExpenses.map(t => ({...t, type: 'Gasto'}))
            ];

            // Ordenar por fecha (m√°s reciente primero)
            allCurrentTransactions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            // 3. Crear el contenido CSV
            const headers = ["ID", "Tipo", "Nombre", "Monto", "Fecha"];
            let csvContent = headers.join(";") + "\n"; // Usamos punto y coma (;)

            allCurrentTransactions.forEach(item => {
                const amount = item.amount.toFixed(2); 
                const dateString = new Date(item.timestamp).toLocaleDateString('es-PE');
                
                const row = [
                    `"${item.id}"`,
                    item.type,
                    `"${item.name.replace(/"/g, '""')}"`,
                    amount,
                    dateString
                ];
                csvContent += row.join(";") + "\n";
            });

            // 4. Crear y descargar el archivo
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            
            const filterValue = elements.monthFilter.value;
            const fileName = `finanzas-export-${filterValue}.csv`;
            
            a.setAttribute('download', fileName);
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showMessage(`Datos exportados exitosamente como ${fileName}`, 'success');
        }


        // --- Inicializaci√≥n de la Aplicaci√≥n (Usando Firebase Listeners) ---

        function initApp() {
            // 1. Llenar el filtro de meses
            populateMonthFilter();

            // 2. Asignaci√≥n de Eventos
            elements.monthFilter.addEventListener('change', handleFilterChange);
            elements.addIncomeBtn.addEventListener('click', () => {
                addTransaction(elements.incomeName.value, elements.incomeAmount.value, 'income');
            });
            elements.addExpenseBtn.addEventListener('click', () => {
                addTransaction(elements.expenseName.value, elements.expenseAmount.value, 'expense');
            });
            elements.analyzeButton.addEventListener('click', analyzeFinancesWithGemini);
            elements.exportBtn.addEventListener('click', exportDataToCSV);

            // 3. Establecer Listeners de Firebase para la actualizaci√≥n en tiempo real
            db.collection('users').doc(userId).collection('incomes').onSnapshot(loadAndFilterData);
            db.collection('users').doc(userId).collection('expenses').onSnapshot(loadAndFilterData);

            // Nota: Con onSnapshot, no necesitamos llamar a loadAndFilterData() aqu√≠. 
            // La primera carga se dispara autom√°ticamente.
        }

        initApp();

    </script>
</body>
</html>
