<!DOCTYPE html>

<html lang="es">

<head>

ย ย <meta charset="UTF-8">

ย ย <meta name="viewport" content="width=device-width, initial-scale=1.0">

ย ย <title>Control de Ingresos y Gastos</title>

ย ย <script src="https://cdn.tailwindcss.com"></script>

ย ย <style>

ย ย ย ย /* Fuente Inter por defecto y estilo de fondo */

ย ย ย ย body {

ย ย ย ย ย ย font-family: 'Inter', sans-serif;

ย ย ย ย ย ย background-color: #f7f9fb;

ย ย ย ย }

ย ย ย ย /* Ocultar la barra de desplazamiento en los contenedores de listas */

ย ย ย ย .list-container {

ย ย ย ย ย ย max-height: 250px;

ย ย ย ย ย ย overflow-y: auto;

ย ย ย ย ย ย scrollbar-width: none; /* Firefox */

ย ย ย ย }

ย ย </style>

ย ย <script type="module">

ย ย ย ยย

ย ย ย ย // --- AUTODIAGNรSTICO CRรTICO PARA USO LOCAL ---

ย ย ย ย if (window.location.protocol === 'file:') {

ย ย ย ย ย ย // Si se ejecuta localmente (file://), muestra un error claro y termina la ejecuciรณn de Firebase.

ย ย ย ย ย ย window.onload = function() {

ย ย ย ย ย ย ย ย const messageBox = document.getElementById('message-box');

ย ย ย ย ย ย ย ย if (messageBox) {

ย ย ย ย ย ย ย ย ย ย messageBox.textContent = "โ ERROR CRรTICO: Las bases de datos y la funcionalidad avanzada no funcionan si abres este archivo directamente (protocolo 'file://'). POR FAVOR, USA EL BOTรN 'PREVIEW' O LA VERSIรN ONLINE.";

ย ย ย ย ย ย ย ย ย ย messageBox.className = 'p-4 rounded-xl mt-4 text-sm font-bold text-center bg-red-600 text-white shadow-xl';

ย ย ย ย ย ย ย ย ย ย messageBox.classList.remove('hidden');

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย };


ย ย ย ย }

ย ย ย ย // --- FIN DE AUTODIAGNรSTICO ---





ย ย ย ย import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

ย ย ย ย import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

ย ย ย ย import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";



ย ย ย ย // --- Configuraciรณn e Inicializaciรณn de Firebase (CORREGIDA) ---

ย ย ย ย const firebaseConfig = {

ย ย ย ย ย ย apiKey: "AIzaSyCil5A3PMp9-vUY5qTK_wbTmLtStqAEs9E",

ย ย ย ย ย ย authDomain: "financia2-4f80e.firebaseapp.com",

ย ย ย ย ย ย projectId: "financia2-4f80e",

ย ย ย ย ย ย storageBucket: "financia2-4f80e.firebasestorage.app",

ย ย ย ย ย ย messagingSenderId: "1076125827715",

ย ย ย ย ย ย appId: "1:1076125827715:web:6cdb2eb77a937be4fe11b6"

ย ย ย ย ย ย // measurementId no es necesario para la inicializaciรณn bรกsica

ย ย ย ย };

ย ย ย ย const appId = firebaseConfig.projectId; // Usa el Project ID como el App ID para la lรณgica interna

ย ย ย ย const initialAuthToken = null; // No usamos el token inicial en esta configuraciรณn



ย ย ย ย const dbApp = initializeApp(firebaseConfig);

ย ย ย ย const db = getFirestore(dbApp);

ย ย ย ย const auth = getAuth(dbApp);

ย ย ย ย setLogLevel('debug');



ย ย ย ย // --- Variables de Estado Global y Referencias de Firestore ---

ย ย ย ย window.userId = null;ย

ย ย ย ย window.db = db;

ย ย ย ย const EXPENSE_COLLECTION = 'expenses';

ย ย ย ย const INCOME_COLLECTION = 'incomes';

ย ย ย ยย

ย ย ย ย // Almacenamiento de TODAS las transacciones (sin filtrar)

ย ย ย ย window.allIncomes = [];

ย ย ย ย window.allExpenses = [];



ย ย ย ย // Almacenamiento de transacciones FILTRADAS (usadas por LLM y CSV)

ย ย ย ย window.currentIncomes = [];

ย ย ย ย window.currentExpenses = [];



ย ย ย ย // Configuraciรณn de la API Gemini

ย ย ย ย const apiKey = "AIzaSyAiRIs1hTzS4ABu-ykWVqoP2wmlGHh3gEs";

ย ย ย ย const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;



ย ย ย ย // Funciรณn para codificar una espera con retroceso exponencial (manejo de errores de API).

ย ย ย ย const exponentialBackoff = async (attempt) => {

ย ย ย ย ย ย const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;

ย ย ย ย ย ย return new Promise(resolve => setTimeout(resolve, delay));

ย ย ย ย };

ย ย ย ยย

ย ย ย ย // Funciรณn para obtener la referencia de la colecciรณn de un usuario (privada)

ย ย ย ย const getCollectionRef = (collectionName) => {

ย ย ย ย ย ย if (!window.userId || !appId) return null;

ย ย ย ย ย ย return collection(window.db, `artifacts/${appId}/users/${window.userId}/${collectionName}`);

ย ย ย ย };



ย ย ย ย // --- Referencias de Elementos de UI ---

ย ย ย ย const incomeNameInput = document.getElementById('income-name');

ย ย ย ย const incomeAmountInput = document.getElementById('income-amount');

ย ย ย ย const expenseNameInput = document.getElementById('expense-name');

ย ย ย ย const expenseAmountInput = document.getElementById('expense-amount');



ย ย ย ย const totalIncomeDisplay = document.getElementById('total-income');

ย ย ย ย const totalExpenseDisplay = document.getElementById('total-expense');

ย ย ย ย const netBalanceDisplay = document.getElementById('net-balance');



ย ย ย ย const incomeList = document.getElementById('income-list');

ย ย ย ย const expenseList = document.getElementById('expense-list');

ย ย ย ยย

ย ย ย ย const userIdDisplay = document.getElementById('user-id-display');

ย ย ย ย const messageBox = document.getElementById('message-box');

ย ย ย ย const monthFilter = document.getElementById('month-filter');

ย ย ย ยย

ย ย ย ย // --- Utilidades de UI ---

ย ย ย ย window.showMessage = (message, type = 'error') => {

ย ย ย ย ย ย messageBox.textContent = message;

ย ย ย ย ย ย messageBox.className = 'p-3 rounded-lg mt-4 text-sm font-semibold text-center';

ย ย ย ย ย ย if (type === 'error') {

ย ย ย ย ย ย ย ย messageBox.classList.add('bg-red-100', 'text-red-800');

ย ย ย ย ย ย } else if (type === 'success') {

ย ย ย ย ย ย ย ย messageBox.classList.add('bg-green-100', 'text-green-800');

ย ย ย ย ย ย }

ย ย ย ย ย ย messageBox.classList.remove('hidden');

ย ย ย ย ย ย setTimeout(() => {

ย ย ย ย ย ย ย ย messageBox.classList.add('hidden');

ย ย ย ย ย ย }, 5000);

ย ย ย ย };



ย ย ย ย const formatCurrency = (amount) => {

ย ย ย ย ย ย return `S/ ${amount.toFixed(2)}`;

ย ย ย ย }

ย ย ย ยย

ย ย ย ย // Funciรณn auxiliar para cambiar el color del Balance Neto

ย ย ย ย const updateNetBalanceStyle = (balance) => {

ย ย ย ย ย ย const display = netBalanceDisplay;

ย ย ย ย ย ย display.classList.remove('text-green-500', 'text-red-500', 'text-gray-500');

ย ย ย ย ย ย if (balance > 0) {

ย ย ย ย ย ย ย ย display.classList.add('text-green-500');

ย ย ย ย ย ย } else if (balance < 0) {

ย ย ย ย ย ย ย ย display.classList.add('text-red-500');

ย ย ย ย ย ย } else {

ย ย ย ย ย ย ย ย display.classList.add('text-gray-500');

ย ย ย ย ย ย }

ย ย ย ย };





ย ย ย ย // --- Lรณgica de Filtro y Renderizado ---



ย ย ย ย /**

ย ย ย ย ย* Lรณgica principal que filtra, calcula totales y renderiza las listas.

ย ย ย ย ย* Se llama cada vez que hay un cambio en los datos de Firestore o en el filtro de mes.

ย ย ย ย ย*/

ย ย ย ย window.handleDataChange = () => {

ย ย ย ย ย ย const selectedValue = monthFilter.value; // e.g., "09-2025" o "all"

ย ย ย ย ย ย let totalIncome = 0;

ย ย ย ย ย ย let totalExpenses = 0;

ย ย ย ย ย ยย

ย ย ย ย ย ย // Reset de las transacciones filtradas (para LLM/Exportar)

ย ย ย ย ย ย window.currentIncomes = [];

ย ย ย ย ย ย window.currentExpenses = [];

ย ย ย ย ย ยย

ย ย ย ย ย ย // Funciรณn interna para procesar y renderizar un tipo de lista

ย ย ย ย ย ย const processList = (data, listElement, type) => {

ย ย ย ย ย ย ย ย listElement.innerHTML = '';

ย ย ย ย ย ย ย ย let listTotal = 0;



ย ย ย ย ย ย ย ย if (data.length === 0) {

ย ย ย ย ย ย ย ย ย ย listElement.innerHTML = `<li class="text-center py-4 text-gray-500 italic">No hay ${type === 'income' ? 'ingresos' : 'gastos'} registrados aรบn.</li>`;

ย ย ย ย ย ย ย ย ย ย return 0;

ย ย ย ย ย ย ย ย }



ย ย ย ย ย ย ย ย const filtered = data.filter(t => {

ย ย ย ย ย ย ย ย ย ย if (selectedValue === 'all') return true;

ย ย ย ย ย ย ย ย ย ยย

ย ย ย ย ย ย ย ย ย ย // Comprueba si la fecha de la transacciรณn coincide con el filtro MM-YYYY

ย ย ย ย ย ย ย ย ย ย const month = t.dateObj.getMonth() + 1; // Mes 1-indexado

ย ย ย ย ย ย ย ย ย ย const year = t.dateObj.getFullYear();

ย ย ย ย ย ย ย ย ย ย return `${String(month).padStart(2, '0')}-${year}` === selectedValue;

ย ย ย ย ย ย ย ย });



ย ย ย ย ย ย ย ย if (filtered.length === 0) {

ย ย ย ย ย ย ย ย ย ย listElement.innerHTML = `<li class="text-center py-4 text-gray-500 italic">No hay ${type === 'income' ? 'ingresos' : 'gastos'} registrados en este mes.</li>`;

ย ย ย ย ย ย ย ย }



ย ย ย ย ย ย ย ย filtered.forEach(item => {

ย ย ย ย ย ย ย ย ย ย listTotal += item.amount;

ย ย ย ย ย ย ย ย ย ยย

ย ย ย ย ย ย ย ย ย ย // Almacenar en la lista filtrada global (para LLM/Exportar)

ย ย ย ย ย ย ย ย ย ย if (type === 'income') window.currentIncomes.push(item);

ย ย ย ย ย ย ย ย ย ย if (type === 'expense') window.currentExpenses.push(item);



ย ย ย ย ย ย ย ย ย ย const li = document.createElement('li');

ย ย ย ย ย ย ย ย ย ย const typeColor = type === 'income' ? 'green' : 'red';

ย ย ย ย ย ย ย ย ย ย const deleteFn = `window.deleteTransaction('${item.id}', '${type}')`;

ย ย ย ย ย ย ย ย ย ยย

ย ย ย ย ย ย ย ย ย ย li.className = `flex justify-between items-center p-3 bg-white border-b border-gray-100 hover:bg-${typeColor}-50 transition duration-150 rounded-lg shadow-sm mb-1`;

ย ย ย ย ย ย ย ย ย ย li.innerHTML = `

ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex-1 text-gray-800">

ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span class="block font-medium">${item.name}</span>

ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span class="block text-xs text-gray-500">${item.dateObj.toLocaleDateString()}</span>

ย ย ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย ย ย <span class="text-lg font-bold text-${typeColor}-600 mr-4">

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ${formatCurrency(item.amount)}

ย ย ย ย ย ย ย ย ย ย ย ย </span>

ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="${deleteFn}"ย

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย class="text-gray-400 hover:text-${typeColor}-500 transition duration-150 p-1 rounded-full bg-gray-100 hover:bg-${typeColor}-100"

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย title="Eliminar ${type === 'income' ? 'ingreso' : 'gasto'}">

ย ย ย ย ย ย ย ย ย ย ย ย ย ย <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />

ย ย ย ย ย ย ย ย ย ย ย ย ย ย </svg>

ย ย ย ย ย ย ย ย ย ย ย ย </button>

ย ย ย ย ย ย ย ย ย ย `;

ย ย ย ย ย ย ย ย ย ย listElement.appendChild(li);

ย ย ย ย ย ย ย ย });

ย ย ย ย ย ย ย ย return listTotal;

ย ย ย ย ย ย }



ย ย ย ย ย ย // Procesar ambas listas y obtener totales

ย ย ย ย ย ย totalIncome = processList(window.allIncomes, incomeList, 'income');

ย ย ย ย ย ย totalExpenses = processList(window.allExpenses, expenseList, 'expense');



ย ย ย ย ย ย // Actualizar totales en la UI

ย ย ย ย ย ย totalIncomeDisplay.textContent = formatCurrency(totalIncome);

ย ย ย ย ย ย totalExpenseDisplay.textContent = formatCurrency(totalExpenses);

ย ย ย ย ย ย netBalanceDisplay.textContent = formatCurrency(totalIncome - totalExpenses);

ย ย ย ย ย ย updateNetBalanceStyle(totalIncome - totalExpenses);

ย ย ย ย };



ย ย ย ย // Alias para el evento onchange del selector

ย ย ย ย window.applyFilterAndRecalculate = window.handleDataChange;ย



ย ย ย ย /**

ย ย ย ย ย* Llena el selector de meses con los รบltimos 12 meses.

ย ย ย ย ย*/

ย ย ย ย const populateMonthFilter = () => {

ย ย ย ย ย ย const today = new Date();

ย ย ย ย ย ย const currentMonth = today.getMonth();

ย ย ย ย ย ย const currentYear = today.getFullYear();

ย ย ย ย ย ย const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];



ย ย ย ย ย ย let optionsHTML = `<option value="all">Ver Todas las Transacciones</option>`;



ย ย ย ย ย ย // Generar opciones para los รบltimos 12 meses (incluyendo el actual)

ย ย ย ย ย ย for (let i = 0; i < 12; i++) {

ย ย ย ย ย ย ย ย // Se resta 'i' para ir hacia el pasado (mes - i)

ย ย ย ย ย ย ย ย let date = new Date(currentYear, currentMonth - i, 1);

ย ย ย ย ย ย ย ย const month = date.getMonth();

ย ย ย ย ย ย ย ย const year = date.getFullYear();

ย ย ย ย ย ย ย ย // Valor en formato MM-YYYY (usamos mes + 1 porque en JS es 0-indexado)

ย ย ย ย ย ย ย ย const value = `${String(month + 1).padStart(2, '0')}-${year}`;ย

ย ย ย ย ย ย ย ย const label = `${monthNames[month]} ${year}`;

ย ย ย ย ย ย ย ยย

ย ย ย ย ย ย ย ย optionsHTML += `<option value="${value}" ${i === 0 ? 'selected' : ''}>${label}</option>`;

ย ย ย ย ย ย }

ย ย ย ย ย ยย

ย ย ย ย ย ย monthFilter.innerHTML = optionsHTML;

ย ย ย ย };





ย ย ย ย // --- Lรณgica de Autenticaciรณn y Carga Inicial ---

ย ย ย ยย

ย ย ย ย /**

ย ย ย ย ย* Configura los listeners de Firestore para obtener los datos en tiempo real.

ย ย ย ย ย*/

ย ย ย ย window.loadFinancialData = () => {

ย ย ย ย ย ย // --- Listener de Gastos ---

ย ย ย ย ย ย const expensesRef = getCollectionRef(EXPENSE_COLLECTION);

ย ย ย ย ย ย if (expensesRef) {

ย ย ย ย ย ย ย ย onSnapshot(query(expensesRef), (snapshot) => {

ย ย ย ย ย ย ย ย ย ย // Mapear los documentos y aรฑadir el objeto de fecha y el ID

ย ย ย ย ย ย ย ย ย ย window.allExpenses = snapshot.docs.map(doc => ({ย

ย ย ย ย ย ย ย ย ย ย ย ย ...doc.data(),ย

ย ย ย ย ย ย ย ย ย ย ย ย id: doc.id,

ย ย ย ย ย ย ย ย ย ย ย ย dateObj: doc.data().timestamp?.toDate() || new Date()

ย ย ย ย ย ย ย ย ย ย }));

ย ย ย ย ย ย ย ย ย ย window.handleDataChange(); // Recalcula y renderiza

ย ย ย ย ย ย ย ย }, (error) => {

ย ย ย ย ย ย ย ย ย ย console.error("Error en onSnapshot (Gastos):", error);

ย ย ย ย ย ย ย ย });

ย ย ย ย ย ย }



ย ย ย ย ย ย // --- Listener de Ingresos ---

ย ย ย ย ย ย const incomesRef = getCollectionRef(INCOME_COLLECTION);

ย ย ย ย ย ย if (incomesRef) {

ย ย ย ย ย ย ย ย onSnapshot(query(incomesRef), (snapshot) => {

ย ย ย ย ย ย ย ย ย ย // Mapear los documentos y aรฑadir el objeto de fecha y el ID

ย ย ย ย ย ย ย ย ย ย window.allIncomes = snapshot.docs.map(doc => ({ย

ย ย ย ย ย ย ย ย ย ย ย ย ...doc.data(),ย

ย ย ย ย ย ย ย ย ย ย ย ย id: doc.id,

ย ย ย ย ย ย ย ย ย ย ย ย dateObj: doc.data().timestamp?.toDate() || new Date()

ย ย ย ย ย ย ย ย ย ย }));

ย ย ย ย ย ย ย ย ย ย window.handleDataChange(); // Recalcula y renderiza

ย ย ย ย ย ย ย ย }, (error) => {

ย ย ย ย ย ย ย ย ย ย console.error("Error en onSnapshot (Ingresos):", error);

ย ย ย ย ย ย ย ย });

ย ย ย ย ย ย }

ย ย ย ย };



ย ย ย ย onAuthStateChanged(auth, async (user) => {

ย ย ย ย ย ย try {

ย ย ย ย ย ย ย ย if (!user) {

ย ย ย ย ย ย ย ย ย ย await signInAnonymously(auth);

ย ย ย ย ย ย ย ย ย ย user = auth.currentUser;

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย window.userId = user.uid;

ย ย ย ย ย ย ย ย userIdDisplay.textContent = `ID de Sesiรณn: ${window.userId.substring(0, 10)}...`;

ย ย ย ย ย ย ย ย userIdDisplay.title = window.userId;



ย ย ย ย ย ย ย ย populateMonthFilter();

ย ย ย ย ย ย ย ย window.loadFinancialData();

ย ย ย ย ย ย } catch (e) {

ย ย ย ย ย ย ย ย console.error("Error de autenticaciรณn inicial:", e);

ย ย ย ย ย ย ย ย window.showMessage("No se pudo iniciar sesiรณn. Verifica la consola.");

ย ย ย ย ย ย }

ย ย ย ย });



ย ย ย ย if (initialAuthToken) {

ย ย ย ย ย ย signInWithCustomToken(auth, initialAuthToken).catch(e => {

ย ย ย ย ย ย ย ย console.error("Error signing in with custom token, proceeding anonymously:", e);

ย ย ย ย ย ย });

ย ย ย ย }



ย ย ย ย // --- Funciones CRUD de Datos ---



ย ย ย ย /**

ย ย ย ย ย* Aรฑade una nueva transacciรณn (ingreso o gasto) a Firestore.

ย ย ย ย ย*/

ย ย ย ย const addTransaction = async (name, amount, type) => {

ย ย ย ย ย ย if (!name || isNaN(amount) || amount <= 0) {

ย ย ย ย ย ย ย ย window.showMessage("Por favor, ingresa un nombre y una cantidad vรกlida (mayor a 0).");

ย ย ย ย ย ย ย ย return;

ย ย ย ย ย ย }



ย ย ย ย ย ย if (!window.userId) {

ย ย ย ย ย ย ย ย window.showMessage("Error: Usuario no autenticado.");

ย ย ย ย ย ย ย ย return;

ย ย ย ย ย ย }



ย ย ย ย ย ย const collectionName = type === 'income' ? INCOME_COLLECTION : EXPENSE_COLLECTION;



ย ย ย ย ย ย try {

ย ย ย ย ย ย ย ย await addDoc(getCollectionRef(collectionName), {

ย ย ย ย ย ย ย ย ย ย name: name,

ย ย ย ย ย ย ย ย ย ย amount: amount,

ย ย ย ย ย ย ย ย ย ย timestamp: serverTimestamp()

ย ย ย ย ย ย ย ย });



ย ย ย ย ย ย ย ย // Limpiar campos y mostrar รฉxito

ย ย ย ย ย ย ย ย if (type === 'income') {

ย ย ย ย ย ย ย ย ย ย incomeNameInput.value = '';

ย ย ย ย ย ย ย ย ย ย incomeAmountInput.value = '';

ย ย ย ย ย ย ย ย ย ย window.showMessage("Ingreso registrado con รฉxito.", 'success');

ย ย ย ย ย ย ย ย } else {

ย ย ย ย ย ย ย ย ย ย expenseNameInput.value = '';

ย ย ย ย ย ย ย ย ย ย expenseAmountInput.value = '';

ย ย ย ย ย ย ย ย ย ย window.showMessage("Gasto registrado con รฉxito.", 'success');

ย ย ย ย ย ย ย ย }



ย ย ย ย ย ย } catch (e) {

ย ย ย ย ย ย ย ย console.error(`Error al aรฑadir ${type}: `, e);

ย ย ย ย ย ย ย ย window.showMessage(`Error al guardar el ${type}. Revisa la consola.`);

ย ย ย ย ย ย }

ย ย ย ย };



ย ย ย ย window.addIncome = () => addTransaction(incomeNameInput.value.trim(), parseFloat(incomeAmountInput.value), 'income');

ย ย ย ย window.addExpense = () => addTransaction(expenseNameInput.value.trim(), parseFloat(expenseAmountInput.value), 'expense');





ย ย ย ย /**

ย ย ย ย ย* Elimina una transacciรณn de Firestore.

ย ย ย ย ย*/

ย ย ย ย window.deleteTransaction = async (docId, type) => {

ย ย ย ย ย ย ยif (!window.userId) {

ย ย ย ย ย ย ย ย window.showMessage("Error: Usuario no autenticado.");

ย ย ย ย ย ย ย ย return;

ย ย ย ย ย ย }

ย ย ย ย ย ย const collectionName = type === 'income' ? INCOME_COLLECTION : EXPENSE_COLLECTION;

ย ย ย ย ย ยย

ย ย ย ย ย ย try {

ย ย ย ย ย ย ย ย const docRef = doc(window.db, `artifacts/${appId}/users/${window.userId}/${collectionName}`, docId);

ย ย ย ย ย ย ย ย await deleteDoc(docRef);

ย ย ย ย ย ย ย ย window.showMessage(`${type === 'income' ? 'Ingreso' : 'Gasto'} eliminado.`, 'success');

ย ย ย ย ย ย } catch (e) {

ย ย ย ย ย ย ย ย console.error("Error al eliminar documento: ", e);

ย ย ย ย ย ย ย ย window.showMessage("Error al eliminar la transacciรณn. Revisa la consola.");

ย ย ย ย ย ย }

ย ย ย ย };





ย ย ย ย // --- Funciones de la API Gemini ---

ย ย ย ย window.analyzeFinancesWithGemini = async () => {

ย ย ย ย ย ย const analysisButton = document.getElementById('analyze-button');

ย ย ย ย ย ย const analysisResult = document.getElementById('analysis-result');

ย ย ย ย ย ยย

ย ย ย ย ย ย analysisButton.disabled = true;

ย ย ย ย ย ย analysisResult.innerHTML = '<p class="text-center text-gray-500 italic animate-pulse">Analizando datos con la IA...</p>';



ย ย ย ย ย ย const totalIncome = parseFloat(totalIncomeDisplay.textContent.replace('S/ ', '').replace(',', '') || 0);

ย ย ย ย ย ย const totalExpenses = parseFloat(totalExpenseDisplay.textContent.replace('S/ ', '').replace(',', '') || 0);

ย ย ย ย ย ย const netBalance = totalIncome - totalExpenses;



ย ย ย ย ย ย // Formatear los detalles de las transacciones (usando las FILTRADAS)

ย ย ย ย ย ย const formatTransactions = (transactions, type) => {

ย ย ย ย ย ย ย ย if (transactions.length === 0) return `No hay ${type} registrados en el mes actual.`;

ย ย ย ย ย ย ย ย return transactions.map(t =>ย

ย ย ย ย ย ย ย ย ย ย `- ${t.name}: S/ ${t.amount.toFixed(2)}`

ย ย ย ย ย ย ย ย ).join('\n');

ย ย ย ย ย ย };



ย ย ย ย ย ย const incomeDetails = formatTransactions(window.currentIncomes, 'ingresos');

ย ย ย ย ย ย const expenseDetails = formatTransactions(window.currentExpenses, 'gastos');



ย ย ย ย ย ย // Construir el prompt para el LLM

ย ย ย ย ย ย const systemPrompt = "Actรบa como un asesor financiero profesional. Analiza los datos de ingresos y gastos proporcionados por el usuario. Proporciona un breve resumen de la situaciรณn, identifica el gasto mรกs grande o un รกrea de mejora, y ofrece un consejo financiero conciso y prรกctico basado en los datos. La respuesta debe ser formal, en espaรฑol y sin preรกmbulos, comenzando directamente con el anรกlisis. No uses emojis.";

ย ย ย ย ย ยย

ย ย ย ย ย ย const userQuery = `

ย ย ย ย ย ย ย ย Datos Financieros Mensuales (Soles Peruanos) para el periodo seleccionado:

ย ย ย ย ย ย ย ย Total Ingresos: ${formatCurrency(totalIncome)}

ย ย ย ย ย ย ย ย Total Gastos: ${formatCurrency(totalExpenses)}

ย ย ย ย ย ย ย ย Balance Neto: ${formatCurrency(netBalance)}

ย ย ย ย ย ย ย ยย

ย ย ย ย ย ย ย ย Detalle de Ingresos:

ย ย ย ย ย ย ย ย ${incomeDetails}



ย ย ย ย ย ย ย ย Detalle de Gastos:

ย ย ย ย ย ย ย ย ${expenseDetails}



ย ย ย ย ย ย ย ย Por favor, genera un anรกlisis financiero.

ย ย ย ย ย ย `;

ย ย ย ย ย ยย

ย ย ย ย ย ย const payload = {

ย ย ย ย ย ย ย ย contents: [{ parts: [{ text: userQuery }] }],

ย ย ย ย ย ย ย ย systemInstruction: {

ย ย ย ย ย ย ย ย ย ย parts: [{ text: systemPrompt }]

ย ย ย ย ย ย ย ย },

ย ย ย ย ย ย ย ย tools: [{ "google_search": {} }],

ย ย ย ย ย ย };

ย ย ย ย ย ยย

ย ย ย ย ย ย const maxRetries = 3;



ย ย ย ย ย ย for (let attempt = 1; attempt <= maxRetries; attempt++) {

ย ย ย ย ย ย ย ย try {

ย ย ย ย ย ย ย ย ย ย const response = await fetch(apiUrl, {

ย ย ย ย ย ย ย ย ย ย ย ย method: 'POST',

ย ย ย ย ย ย ย ย ย ย ย ย headers: { 'Content-Type': 'application/json' },

ย ย ย ย ย ย ย ย ย ย ย ย body: JSON.stringify(payload)

ย ย ย ย ย ย ย ย ย ย });



ย ย ย ย ย ย ย ย ย ย if (!response.ok) {

ย ย ย ย ย ย ย ย ย ย ย ย if (response.status >= 400 && response.status < 500) {

ย ย ย ย ย ย ย ย ย ย ย ย ย ย throw new Error('Error del cliente (4xx). No se puede reintentar.');

ย ย ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย ย ย ย ย throw new Error(`Error de red o servidor: ${response.status}`);

ย ย ย ย ย ย ย ย ย ย }



ย ย ย ย ย ย ย ย ย ย const result = await response.json();

ย ย ย ย ย ย ย ย ย ย const text = result.candidates?.[0]?.content?.parts?.[0]?.text;



ย ย ย ย ย ย ย ย ย ย if (text) {

ย ย ย ย ย ย ย ย ย ย ย ย // Reemplazar saltos de lรญnea para un formato limpio

ย ย ย ย ย ย ย ย ย ย ย ย analysisResult.innerHTML = `<p class="whitespace-pre-wrap text-gray-700 text-left">${text.replace(/\n/g, '<br>')}</p>`;

ย ย ย ย ย ย ย ย ย ย ย ย break;

ย ย ย ย ย ย ย ย ย ย } else {

ย ย ย ย ย ย ย ย ย ย ย ย throw new Error('Respuesta de la IA vacรญa o inesperada.');

ย ย ย ย ย ย ย ย ย ย }



ย ย ย ย ย ย ย ย } catch (error) {

ย ย ย ย ย ย ย ย ย ย console.error(`Intento ${attempt} fallido:`, error.message);

ย ย ย ย ย ย ย ย ย ย if (attempt < maxRetries && error.message.indexOf('4xx') === -1) {

ย ย ย ย ย ย ย ย ย ย ย ย await exponentialBackoff(attempt);

ย ย ย ย ย ย ย ย ย ย } else {

ย ย ย ย ย ย ย ย ย ย ย ย analysisResult.innerHTML = '<p class="text-red-600 font-semibold text-center">โ Error al generar el anรกlisis. Intรฉntalo de nuevo.</p>';

ย ย ย ย ย ย ย ย ย ย ย ย break;

ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย }

ย ย ย ย ย ย analysisButton.disabled = false;

ย ย ย ย };





ย ย ย ย // --- Funciรณn de Exportaciรณn CSV ---

ย ย ย ย /**

ย ย ย ย ย* Funciรณn para exportar todos los ingresos y gastos a un archivo CSV.

ย ย ย ย ย* NOTA: Esta funciรณn ahora exporta SOLO los datos filtrados actualmente.

ย ย ย ย ย*/

ย ย ย ย window.exportDataToCSV = () => {

ย ย ย ย ย ย // 1. Recopilar y unificar solo los datos FILTRADOS (currentIncomes/Expenses)

ย ย ย ย ย ย const allTransactions = [];

ย ย ย ย ย ย window.currentIncomes.forEach(t => {

ย ย ย ย ย ย ย ย allTransactions.push({ย

ย ย ย ย ย ย ย ย ย ย date: t.dateObj ? t.dateObj.toLocaleDateString('es-PE') : new Date().toLocaleDateString('es-PE'),ย

ย ย ย ย ย ย ย ย ย ย type: 'INGRESO',ย

ย ย ย ย ย ย ย ย ย ย name: t.name,ย

ย ย ย ย ย ย ย ย ย ย amount: t.amountย

ย ย ย ย ย ย ย ย });

ย ย ย ย ย ย });

ย ย ย ย ย ย window.currentExpenses.forEach(t => {

ย ย ย ย ย ย ย ย allTransactions.push({ย

ย ย ย ย ย ย ย ย ย ย date: t.dateObj ? t.dateObj.toLocaleDateString('es-PE') : new Date().toLocaleDateString('es-PE'),ย

ย ย ย ย ย ย ย ย ย ย type: 'GASTO',ย

ย ย ย ย ย ย ย ย ย ย name: t.name,ย

ย ย ย ย ย ย ย ย ย ย amount: t.amountย

ย ย ย ย ย ย ย ย });

ย ย ย ย ย ย });



ย ย ย ย ย ย if (allTransactions.length === 0) {

ย ย ย ย ย ย ย ย window.showMessage("No hay transacciones filtradas para exportar.", 'error');

ย ย ย ย ย ย ย ย return;

ย ย ย ย ย ย }



ย ย ย ย ย ย // 2. Crear el contenido CSV

ย ย ย ย ย ย const headers = ["Fecha", "Tipo", "Nombre", "Monto (S/)"];

ย ย ย ย ย ย const filterLabel = monthFilter.options[monthFilter.selectedIndex].text.replace(/\s/g, '_');

ย ย ย ย ย ยย

ย ย ย ย ย ย // Funciรณn para escapar comillas dobles

ย ย ย ย ย ย const escapeCSV = (str) => {

ย ย ย ย ย ย ย ย if (typeof str === 'string') {

ย ย ย ย ย ย ย ย ย ย return `"${str.replace(/"/g, '""')}"`;

ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย return str;

ย ย ย ย ย ย };



ย ย ย ย ย ย let csvContent = headers.map(escapeCSV).join(",") + "\n";



ย ย ย ย ย ย allTransactions.forEach(item => {

ย ย ย ย ย ย ย ย const row = [

ย ย ย ย ย ย ย ย ย ย escapeCSV(item.date),

ย ย ย ย ย ย ย ย ย ย escapeCSV(item.type),

ย ย ย ย ย ย ย ย ย ย escapeCSV(item.name),

ย ย ย ย ย ย ย ย ย ย item.amount.toFixed(2)

ย ย ย ย ย ย ย ย ];

ย ย ย ย ย ย ย ย csvContent += row.join(",") + "\n";

ย ย ย ย ย ย });



ย ย ย ย ย ย // 3. Crear Blob y forzar la descarga

ย ย ย ย ย ย const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });

ย ย ย ย ย ย const link = document.createElement("a");

ย ย ย ย ย ย const url = URL.createObjectURL(blob);

ย ย ย ย ย ยย

ย ย ย ย ย ย link.setAttribute("href", url);

ย ย ย ย ย ย link.setAttribute("download", `Finanzas_${filterLabel}_${new Date().toISOString().slice(0, 10)}.csv`);

ย ย ย ย ย ย link.style.visibility = 'hidden';

ย ย ย ย ย ย document.body.appendChild(link);

ย ย ย ย ย ย link.click();

ย ย ย ย ย ย document.body.removeChild(link);

ย ย ย ย ย ยย

ย ย ย ย ย ย window.showMessage(`Datos de ${filterLabel} exportados a CSV con รฉxito.`, 'success');

ย ย ย ย };



ย ย </script>

</head>

<body class="p-4 sm:p-8 min-h-screen flex items-start justify-center">



ย ย <div class="w-full max-w-4xl bg-white shadow-2xl rounded-xl p-6 sm:p-8 space-y-8">



ย ย ย ย <header class="border-b pb-4 border-indigo-100">

ย ย ย ย ย ย <h1 class="text-4xl font-extrabold text-gray-800">

ย ย ย ย ย ย ย ย ๐ Control Financiero (Soles Peruanos)

ย ย ย ย ย ย </h1>

ย ย ย ย ย ย <p id="user-id-display" class="text-xs text-gray-500 mt-1" title="ID Completo del Usuario">

ย ย ย ย ย ย ย ย Cargando autenticaciรณn...

ย ย ย ย ย ย </p>

ย ย ย ย </header>



ย ย ย ย <div id="message-box" class="hidden"></div>



ย ย ย ย <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">

ย ย ย ย ย ยย

ย ย ย ย ย ย <div class="bg-green-500 text-white rounded-xl p-4 shadow-lg">

ย ย ย ย ย ย ย ย <span class="text-sm font-medium uppercase tracking-wider block">Total Ingresos</span>

ย ย ย ย ย ย ย ย <span id="total-income" class="text-2xl sm:text-3xl font-black">S/ 0.00</span>

ย ย ย ย ย ย </div>



ย ย ย ย ย ย <div class="bg-red-500 text-white rounded-xl p-4 shadow-lg">

ย ย ย ย ย ย ย ย <span class="text-sm font-medium uppercase tracking-wider block">Total Gastos</span>

ย ย ย ย ย ย ย ย <span id="total-expense" class="text-2xl sm:text-3xl font-black">S/ 0.00</span>

ย ย ย ย ย ย </div>



ย ย ย ย ย ย <div class="bg-indigo-100 rounded-xl p-4 shadow-lg">

ย ย ย ย ย ย ย ย <span class="text-sm font-medium uppercase tracking-wider block text-gray-700">Balance Neto</span>

ย ย ย ย ย ย ย ย <span id="net-balance" class="text-3xl font-black text-gray-500">S/ 0.00</span>

ย ย ย ย ย ย </div>

ย ย ย ย </div>

ย ย ย ยย

ย ย ย ย <div class="p-4 bg-indigo-50 rounded-xl border border-indigo-200 shadow-inner">

ย ย ย ย ย ย <label for="month-filter" class="block text-lg font-semibold text-indigo-700 mb-2">Filtrar por Mes:</label>

ย ย ย ย ย ย <select id="month-filter" onchange="window.applyFilterAndRecalculate()"

ย ย ย ย ย ย ย ย ย ย class="w-full p-3 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-white">

ย ย ย ย ย ย ย ย <option value="all">Cargando...</option>

ย ย ย ย ย ย ย ย </select>

ย ย ย ย </div>





ย ย ย ย <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

ย ย ย ยย

ย ย ย ย ย ย <div class="bg-green-50 p-6 rounded-xl border border-green-200 space-y-4">

ย ย ย ย ย ย ย ย <h2 class="text-2xl font-semibold text-green-700 flex items-center">

ย ย ย ย ย ย ย ย ย ย <span class="mr-2">โ</span> Registrar Ingreso

ย ย ย ย ย ย ย ย </h2>

ย ย ย ย ย ย ย ย <div class="flex flex-col sm:flex-row gap-3">

ย ย ย ย ย ย ย ย ย ย <input type="text" id="income-name" placeholder="Ej: Salario, Venta, Regalo"

ย ย ย ย ย ย ย ย ย ย ย ย ย ยclass="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500"

ย ย ย ย ย ย ย ย ย ย ย ย ย ยmaxlength="50">

ย ย ย ย ย ย ย ย ย ย <input type="number" id="income-amount" placeholder="S/ 0.00"

ย ย ย ย ย ย ย ย ย ย ย ย ย ยclass="w-full sm:w-28 p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500"

ย ย ย ย ย ย ย ย ย ย ย ย ย ยmin="0.01" step="0.01">

ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <button onclick="window.addIncome()"

ย ย ย ย ย ย ย ย ย ย ย ย class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow-md transition duration-200">

ย ย ย ย ย ย ย ย ย ย Aรฑadir Ingreso

ย ย ย ย ย ย ย ย </button>

ย ย ย ย ย ย </div>

ย ย ย ย ย ยย

ย ย ย ย ย ย <div class="bg-red-50 p-6 rounded-xl border border-red-200 space-y-4">

ย ย ย ย ย ย ย ย <h2 class="text-2xl font-semibold text-red-700 flex items-center">

ย ย ย ย ย ย ย ย ย ย <span class="mr-2">โ</span> Registrar Gasto

ย ย ย ย ย ย ย ย </h2>

ย ย ย ย ย ย ย ย <div class="flex flex-col sm:flex-row gap-3">

ย ย ย ย ย ย ย ย ย ย <input type="text" id="expense-name" placeholder="Ej: Alquiler, Comida, Transporte"

ย ย ย ย ย ย ย ย ย ย ย ย ย ยclass="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500"

ย ย ย ย ย ย ย ย ย ย ย ย ย ยmaxlength="50">

ย ย ย ย ย ย ย ย ย ย <input type="number" id="expense-amount" placeholder="S/ 0.00"

ย ย ย ย ย ย ย ย ย ย ย ย ย ยclass="w-full sm:w-28 p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500"

ย ย ย ย ย ย ย ย ย ย ย ย ย ยmin="0.01" step="0.01">

ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <button onclick="window.addExpense()"

ย ย ย ย ย ย ย ย ย ย ย ย class="w-full py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg shadow-md transition duration-200">

ย ย ย ย ย ย ย ย ย ย Aรฑadir Gasto

ย ย ย ย ย ย ย ย </button>

ย ย ย ย ย ย </div>

ย ย ย ย </div>

ย ย ย ยย

ย ย ย ย <div class="grid grid-cols-1 md:grid-cols-2 gap-6">



ย ย ย ย ย ย <div class="bg-indigo-50 p-6 rounded-xl border border-indigo-200 space-y-4">

ย ย ย ย ย ย ย ย <h2 class="text-2xl font-semibold text-indigo-700 flex items-center">

ย ย ย ย ย ย ย ย ย ย <span class="mr-2">๐ก</span> Anรกlisis Financiero con IA

ย ย ย ย ย ย ย ย </h2>

ย ย ย ย ย ย ย ย <button id="analyze-button" onclick="window.analyzeFinancesWithGemini()"

ย ย ย ย ย ย ย ย ย ย ย ย class="w-full py-3 bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-lg shadow-md transition duration-200">

ย ย ย ย ย ย ย ย ย ย Generar Anรกlisis con IA

ย ย ย ย ย ย ย ย </button>

ย ย ย ย ย ย ย ย <div id="analysis-result" class="mt-4 p-4 bg-white rounded-lg border border-gray-200 shadow-sm text-sm">

ย ย ย ย ย ย ย ย ย ย <p class="text-gray-500 italic">Haz clic en el botรณn para obtener un resumen y consejos sobre el periodo filtrado.</p>

ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย </div>



ย ย ย ย ย ย <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 space-y-4 flex flex-col justify-between">

ย ย ย ย ย ย ย ย <div>

ย ย ย ย ย ย ย ย ย ย <h2 class="text-2xl font-semibold text-gray-700 flex items-center">

ย ย ย ย ย ย ย ย ย ย ย ย <span class="mr-2">๐พ</span> Exportar Datos

ย ย ย ย ย ย ย ย ย ย </h2>

ย ย ย ย ย ย ย ย ย ย <p class="text-sm text-gray-600 mt-2">Exporta los ingresos y gastos del periodo **actualmente filtrado** a un archivo CSV (compatible con Excel).</p>

ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <button onclick="window.exportDataToCSV()"

ย ย ย ย ย ย ย ย ย ย ย ย class="w-full py-3 bg-gray-500 hover:bg-gray-600 text-white font-bold rounded-lg shadow-md transition duration-200">

ย ย ย ย ย ย ย ย ย ย Descargar CSV

ย ย ย ย ย ย ย ย </button>

ย ย ย ย ย ย </div>



ย ย ย ย </div>



ย ย ย ย <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 pt-4 border-t border-gray-200">



ย ย ย ย ย ย <div>

ย ย ย ย ย ย ย ย <h2 class="text-2xl font-semibold text-green-700 mb-3">Historial de Ingresos</h2>

ย ย ย ย ย ย ย ย <ul id="income-list" class="list

