// Agrega estas importaciones al inicio del script
import { enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// --- MAIN INITIALIZATION AND LISTENERS ---

/** Sets up the Firestore listeners with persistence */
function setupFirestoreListeners() {
    if (!isAuthReady || !userId) {
        console.warn("setupFirestoreListeners called before authentication is ready.");
        return;
    }

    // Habilitar persistencia offline
    enableIndexedDbPersistence(db)
        .then(() => {
            console.log("Persistencia offline habilitada");
        })
        .catch((err) => {
            console.warn("Persistencia offline no disponible:", err);
        });

    // 1. Listener for Incomes - MEJORADO
    const incomeColRef = collection(db, 'artifacts', appId, 'users', userId, 'incomes');
    onSnapshot(incomeColRef, (snapshot) => {
        console.log(`üì• Ingresos actualizados: ${snapshot.docs.length} documentos`);
        
        allIncomes = snapshot.docs.map(doc => {
            const data = doc.data();
            // Manejar el timestamp correctamente
            let timestamp;
            if (data.timestamp && data.timestamp.toDate) {
                timestamp = data.timestamp.toDate().toISOString();
            } else if (data.timestamp) {
                timestamp = new Date(data.timestamp).toISOString();
            } else {
                timestamp = new Date().toISOString();
            }
            
            return {
                id: doc.id,
                name: data.name || 'Sin nombre',
                amount: data.amount || 0,
                category: data.category || 'General',
                timestamp: timestamp
            };
        });
        
        const allTransactions = [...allIncomes, ...allExpenses];
        populateMonthFilter(allTransactions);
        filterAndRenderData();
        
    }, (error) => {
        console.error("Error listening to incomes:", error);
        showMessage("Error al cargar ingresos en tiempo real.", 'error');
    });

    // 2. Listener for Expenses - MEJORADO
    const expenseColRef = collection(db, 'artifacts', appId, 'users', userId, 'expenses');
    onSnapshot(expenseColRef, (snapshot) => {
        console.log(`üì§ Gastos actualizados: ${snapshot.docs.length} documentos`);
        
        allExpenses = snapshot.docs.map(doc => {
            const data = doc.data();
            // Manejar el timestamp correctamente
            let timestamp;
            if (data.timestamp && data.timestamp.toDate) {
                timestamp = data.timestamp.toDate().toISOString();
            } else if (data.timestamp) {
                timestamp = new Date(data.timestamp).toISOString();
            } else {
                timestamp = new Date().toISOString();
            }
            
            return {
                id: doc.id,
                name: data.name || 'Sin nombre',
                amount: data.amount || 0,
                category: data.category || 'General',
                timestamp: timestamp
            };
        });
        
        const allTransactions = [...allIncomes, ...allExpenses];
        populateMonthFilter(allTransactions);
        filterAndRenderData();
        
    }, (error) => {
        console.error("Error listening to expenses:", error);
        showMessage("Error al cargar gastos en tiempo real.", 'error');
    });
    
    elements.authStatusDisplay.textContent = '‚òÅÔ∏è Conectado (Tiempo Real)';
}

// Funci√≥n mejorada para agregar transacciones
async function addTransaction(name, amount, category, type) {
    if (!isAuthReady) {
        showMessage("Autenticaci√≥n no lista. Intenta de nuevo.", 'warning');
        return;
    }

    const validation = validateTransaction(name, amount, type);
    if (!validation.isValid) {
        showMessage(validation.errors.join(', '));
        return;
    }

    const collectionName = type === 'income' ? 'incomes' : 'expenses';
    
    const transactionData = {
        name: validation.sanitizedName,
        amount: validation.parsedAmount,
        category: category,
        timestamp: Timestamp.fromDate(new Date()),
        createdAt: Timestamp.fromDate(new Date()) // Campo adicional para ordenamiento
    };

    try {
        console.log(`‚ûï Agregando ${type} a Firestore...`);
        const colRef = collection(db, 'artifacts', appId, 'users', userId, collectionName);
        await addDoc(colRef, transactionData);

        // Clear input fields
        if (type === 'income') {
            elements.incomeName.value = '';
            elements.incomeAmount.value = '';
            elements.incomeCategory.value = 'Salario';
        } else {
            elements.expenseName.value = '';
            elements.expenseAmount.value = '';
            elements.expenseCategory.value = 'Alimentaci√≥n';
        }
        
        showMessage(`${type === 'income' ? 'Ingreso' : 'Gasto'} registrado exitosamente.`, 'success');

    } catch (error) {
        console.error("Error al a√±adir la transacci√≥n:", error);
        showMessage(`Error al a√±adir: ${error.message}`, 'error');
    }
}
