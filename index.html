<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Ingresos y Gastos</title>
    <!-- Carga de Tailwind CSS para estilos modernos y responsivos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyCil5A3PMp9-vUY5qTK_wbTmLtStqAEs9E",
  authDomain: "financia2-4f80e.firebaseapp.com",
  projectId: "financia2-4f80e",
  storageBucket: "financia2-4f80e.firebasestorage.app",
  messagingSenderId: "1076125827715",
  appId: "1:1076125827715:web:6cdb2eb77a937be4fe11b6",
  measurementId: "G-VYEJ3H6F9G"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
        /* Fuente Inter por defecto y estilo de fondo */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* Ocultar la barra de desplazamiento en los contenedores de listas */
        .list-container {
            max-height: 250px;
            overflow-y: auto;
            scrollbar-width: none; /* Firefox */
        }
        .list-container::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
    </style>
    <!-- Importaciones de Firebase -->
    <script type="module">
        
        // --- AUTODIAGN√ìSTICO CR√çTICO PARA USO LOCAL ---
        if (window.location.protocol === 'file:') {
            // Si se ejecuta localmente (file://), muestra un error claro y termina la ejecuci√≥n de Firebase.
            window.onload = function() {
                const messageBox = document.getElementById('message-box');
                if (messageBox) {
                    messageBox.textContent = "‚ùå ERROR CR√çTICO: Las bases de datos y la funcionalidad avanzada no funcionan si abres este archivo directamente (protocolo 'file://'). POR FAVOR, USA EL BOT√ìN 'PREVIEW' O LA VERSI√ìN ONLINE.";
                    messageBox.className = 'p-4 rounded-xl mt-4 text-sm font-bold text-center bg-red-600 text-white shadow-xl';
                    messageBox.classList.remove('hidden');
                }
            };
            return; // Termina la ejecuci√≥n de todo el c√≥digo Firebase/Funcional si falla la carga.
        }
        // --- FIN DE AUTODIAGN√ìSTICO ---


        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuraci√≥n e Inicializaci√≥n de Firebase ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-finance-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const dbApp = initializeApp(firebaseConfig);
        const db = getFirestore(dbApp);
        const auth = getAuth(dbApp);
        setLogLevel('debug');

        // --- Variables de Estado Global y Referencias de Firestore ---
        window.userId = null; 
        window.db = db;
        const EXPENSE_COLLECTION = 'expenses';
        const INCOME_COLLECTION = 'incomes';
        
        // Almacenamiento de TODAS las transacciones (sin filtrar)
        window.allIncomes = [];
        window.allExpenses = [];

        // Almacenamiento de transacciones FILTRADAS (usadas por LLM y CSV)
        window.currentIncomes = [];
        window.currentExpenses = [];

        // Configuraci√≥n de la API Gemini
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        // Funci√≥n para codificar una espera con retroceso exponencial (manejo de errores de API).
        const exponentialBackoff = async (attempt) => {
            const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
            return new Promise(resolve => setTimeout(resolve, delay));
        };
        
        // Funci√≥n para obtener la referencia de la colecci√≥n de un usuario (privada)
        const getCollectionRef = (collectionName) => {
            if (!window.userId || !appId) return null;
            return collection(window.db, `artifacts/${appId}/users/${window.userId}/${collectionName}`);
        };

        // --- Referencias de Elementos de UI ---
        const incomeNameInput = document.getElementById('income-name');
        const incomeAmountInput = document.getElementById('income-amount');
        const expenseNameInput = document.getElementById('expense-name');
        const expenseAmountInput = document.getElementById('expense-amount');

        const totalIncomeDisplay = document.getElementById('total-income');
        const totalExpenseDisplay = document.getElementById('total-expense');
        const netBalanceDisplay = document.getElementById('net-balance');

        const incomeList = document.getElementById('income-list');
        const expenseList = document.getElementById('expense-list');
        
        const userIdDisplay = document.getElementById('user-id-display');
        const messageBox = document.getElementById('message-box');
        const monthFilter = document.getElementById('month-filter');
        
        // --- Utilidades de UI ---
        window.showMessage = (message, type = 'error') => {
            messageBox.textContent = message;
            messageBox.className = 'p-3 rounded-lg mt-4 text-sm font-semibold text-center';
            if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-800');
            } else if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-800');
            }
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        };

        const formatCurrency = (amount) => {
            return `S/ ${amount.toFixed(2)}`;
        }
        
        // Funci√≥n auxiliar para cambiar el color del Balance Neto
        const updateNetBalanceStyle = (balance) => {
            const display = netBalanceDisplay;
            display.classList.remove('text-green-500', 'text-red-500', 'text-gray-500');
            if (balance > 0) {
                display.classList.add('text-green-500');
            } else if (balance < 0) {
                display.classList.add('text-red-500');
            } else {
                display.classList.add('text-gray-500');
            }
        };


        // --- L√≥gica de Filtro y Renderizado ---

        /**
         * L√≥gica principal que filtra, calcula totales y renderiza las listas.
         * Se llama cada vez que hay un cambio en los datos de Firestore o en el filtro de mes.
         */
        window.handleDataChange = () => {
            const selectedValue = monthFilter.value; // e.g., "09-2025" o "all"
            let totalIncome = 0;
            let totalExpenses = 0;
            
            // Reset de las transacciones filtradas (para LLM/Exportar)
            window.currentIncomes = [];
            window.currentExpenses = [];
            
            // Funci√≥n interna para procesar y renderizar un tipo de lista
            const processList = (data, listElement, type) => {
                listElement.innerHTML = '';
                let listTotal = 0;

                if (data.length === 0) {
                    listElement.innerHTML = `<li class="text-center py-4 text-gray-500 italic">No hay ${type === 'income' ? 'ingresos' : 'gastos'} registrados a√∫n.</li>`;
                    return 0;
                }

                const filtered = data.filter(t => {
                    if (selectedValue === 'all') return true;
                    
                    // Comprueba si la fecha de la transacci√≥n coincide con el filtro MM-YYYY
                    const month = t.dateObj.getMonth() + 1; // Mes 1-indexado
                    const year = t.dateObj.getFullYear();
                    return `${String(month).padStart(2, '0')}-${year}` === selectedValue;
                });

                if (filtered.length === 0) {
                    listElement.innerHTML = `<li class="text-center py-4 text-gray-500 italic">No hay ${type === 'income' ? 'ingresos' : 'gastos'} registrados en este mes.</li>`;
                }

                filtered.forEach(item => {
                    listTotal += item.amount;
                    
                    // Almacenar en la lista filtrada global (para LLM/Exportar)
                    if (type === 'income') window.currentIncomes.push(item);
                    if (type === 'expense') window.currentExpenses.push(item);

                    const li = document.createElement('li');
                    const typeColor = type === 'income' ? 'green' : 'red';
                    const deleteFn = `window.deleteTransaction('${item.id}', '${type}')`;
                    
                    li.className = `flex justify-between items-center p-3 bg-white border-b border-gray-100 hover:bg-${typeColor}-50 transition duration-150 rounded-lg shadow-sm mb-1`;
                    li.innerHTML = `
                        <div class="flex-1 text-gray-800">
                            <span class="block font-medium">${item.name}</span>
                            <span class="block text-xs text-gray-500">${item.dateObj.toLocaleDateString()}</span>
                        </div>
                        <span class="text-lg font-bold text-${typeColor}-600 mr-4">
                            ${formatCurrency(item.amount)}
                        </span>
                        <button onclick="${deleteFn}" 
                                class="text-gray-400 hover:text-${typeColor}-500 transition duration-150 p-1 rounded-full bg-gray-100 hover:bg-${typeColor}-100"
                                title="Eliminar ${type === 'income' ? 'ingreso' : 'gasto'}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                              <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    `;
                    listElement.appendChild(li);
                });
                return listTotal;
            }

            // Procesar ambas listas y obtener totales
            totalIncome = processList(window.allIncomes, incomeList, 'income');
            totalExpenses = processList(window.allExpenses, expenseList, 'expense');

            // Actualizar totales en la UI
            totalIncomeDisplay.textContent = formatCurrency(totalIncome);
            totalExpenseDisplay.textContent = formatCurrency(totalExpenses);
            netBalanceDisplay.textContent = formatCurrency(totalIncome - totalExpenses);
            updateNetBalanceStyle(totalIncome - totalExpenses);
        };

        // Alias para el evento onchange del selector
        window.applyFilterAndRecalculate = window.handleDataChange; 

        /**
         * Llena el selector de meses con los √∫ltimos 12 meses.
         */
        const populateMonthFilter = () => {
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

            let optionsHTML = `<option value="all">Ver Todas las Transacciones</option>`;

            // Generar opciones para los √∫ltimos 12 meses (incluyendo el actual)
            for (let i = 0; i < 12; i++) {
                // Se resta 'i' para ir hacia el pasado (mes - i)
                let date = new Date(currentYear, currentMonth - i, 1);
                const month = date.getMonth();
                const year = date.getFullYear();
                // Valor en formato MM-YYYY (usamos mes + 1 porque en JS es 0-indexado)
                const value = `${String(month + 1).padStart(2, '0')}-${year}`; 
                const label = `${monthNames[month]} ${year}`;
                
                optionsHTML += `<option value="${value}" ${i === 0 ? 'selected' : ''}>${label}</option>`;
            }
            
            monthFilter.innerHTML = optionsHTML;
        };


        // --- L√≥gica de Autenticaci√≥n y Carga Inicial ---
        
        /**
         * Configura los listeners de Firestore para obtener los datos en tiempo real.
         */
        window.loadFinancialData = () => {
            // --- Listener de Gastos ---
            const expensesRef = getCollectionRef(EXPENSE_COLLECTION);
            if (expensesRef) {
                onSnapshot(query(expensesRef), (snapshot) => {
                    // Mapear los documentos y a√±adir el objeto de fecha y el ID
                    window.allExpenses = snapshot.docs.map(doc => ({ 
                        ...doc.data(), 
                        id: doc.id,
                        dateObj: doc.data().timestamp?.toDate() || new Date()
                    }));
                    window.handleDataChange(); // Recalcula y renderiza
                }, (error) => {
                    console.error("Error en onSnapshot (Gastos):", error);
                });
            }

            // --- Listener de Ingresos ---
            const incomesRef = getCollectionRef(INCOME_COLLECTION);
            if (incomesRef) {
                onSnapshot(query(incomesRef), (snapshot) => {
                    // Mapear los documentos y a√±adir el objeto de fecha y el ID
                    window.allIncomes = snapshot.docs.map(doc => ({ 
                        ...doc.data(), 
                        id: doc.id,
                        dateObj: doc.data().timestamp?.toDate() || new Date()
                    }));
                    window.handleDataChange(); // Recalcula y renderiza
                }, (error) => {
                    console.error("Error en onSnapshot (Ingresos):", error);
                });
            }
        };

        onAuthStateChanged(auth, async (user) => {
            try {
                if (!user) {
                    await signInAnonymously(auth);
                    user = auth.currentUser;
                }
                window.userId = user.uid;
                userIdDisplay.textContent = `ID de Sesi√≥n: ${window.userId.substring(0, 10)}...`;
                userIdDisplay.title = window.userId;

                populateMonthFilter();
                window.loadFinancialData();
            } catch (e) {
                console.error("Error de autenticaci√≥n inicial:", e);
                window.showMessage("No se pudo iniciar sesi√≥n. Verifica la consola.");
            }
        });

        if (initialAuthToken) {
            signInWithCustomToken(auth, initialAuthToken).catch(e => {
                console.error("Error signing in with custom token, proceeding anonymously:", e);
            });
        }

        // --- Funciones CRUD de Datos ---

        /**
         * A√±ade una nueva transacci√≥n (ingreso o gasto) a Firestore.
         */
        const addTransaction = async (name, amount, type) => {
            if (!name || isNaN(amount) || amount <= 0) {
                window.showMessage("Por favor, ingresa un nombre y una cantidad v√°lida (mayor a 0).");
                return;
            }

            if (!window.userId) {
                window.showMessage("Error: Usuario no autenticado.");
                return;
            }

            const collectionName = type === 'income' ? INCOME_COLLECTION : EXPENSE_COLLECTION;

            try {
                await addDoc(getCollectionRef(collectionName), {
                    name: name,
                    amount: amount,
                    timestamp: serverTimestamp()
                });

                // Limpiar campos y mostrar √©xito
                if (type === 'income') {
                    incomeNameInput.value = '';
                    incomeAmountInput.value = '';
                    window.showMessage("Ingreso registrado con √©xito.", 'success');
                } else {
                    expenseNameInput.value = '';
                    expenseAmountInput.value = '';
                    window.showMessage("Gasto registrado con √©xito.", 'success');
                }

            } catch (e) {
                console.error(`Error al a√±adir ${type}: `, e);
                window.showMessage(`Error al guardar el ${type}. Revisa la consola.`);
            }
        };

        window.addIncome = () => addTransaction(incomeNameInput.value.trim(), parseFloat(incomeAmountInput.value), 'income');
        window.addExpense = () => addTransaction(expenseNameInput.value.trim(), parseFloat(expenseAmountInput.value), 'expense');


        /**
         * Elimina una transacci√≥n de Firestore.
         */
        window.deleteTransaction = async (docId, type) => {
             if (!window.userId) {
                window.showMessage("Error: Usuario no autenticado.");
                return;
            }
            const collectionName = type === 'income' ? INCOME_COLLECTION : EXPENSE_COLLECTION;
            
            try {
                const docRef = doc(window.db, `artifacts/${appId}/users/${window.userId}/${collectionName}`, docId);
                await deleteDoc(docRef);
                window.showMessage(`${type === 'income' ? 'Ingreso' : 'Gasto'} eliminado.`, 'success');
            } catch (e) {
                console.error("Error al eliminar documento: ", e);
                window.showMessage("Error al eliminar la transacci√≥n. Revisa la consola.");
            }
        };


        // --- Funciones de la API Gemini ---
        window.analyzeFinancesWithGemini = async () => {
            const analysisButton = document.getElementById('analyze-button');
            const analysisResult = document.getElementById('analysis-result');
            
            analysisButton.disabled = true;
            analysisResult.innerHTML = '<p class="text-center text-gray-500 italic animate-pulse">Analizando datos con la IA...</p>';

            const totalIncome = parseFloat(totalIncomeDisplay.textContent.replace('S/ ', '').replace(',', '') || 0);
            const totalExpenses = parseFloat(totalExpenseDisplay.textContent.replace('S/ ', '').replace(',', '') || 0);
            const netBalance = totalIncome - totalExpenses;

            // Formatear los detalles de las transacciones (usando las FILTRADAS)
            const formatTransactions = (transactions, type) => {
                if (transactions.length === 0) return `No hay ${type} registrados en el mes actual.`;
                return transactions.map(t => 
                    `- ${t.name}: S/ ${t.amount.toFixed(2)}`
                ).join('\n');
            };

            const incomeDetails = formatTransactions(window.currentIncomes, 'ingresos');
            const expenseDetails = formatTransactions(window.currentExpenses, 'gastos');

            // Construir el prompt para el LLM
            const systemPrompt = "Act√∫a como un asesor financiero profesional. Analiza los datos de ingresos y gastos proporcionados por el usuario. Proporciona un breve resumen de la situaci√≥n, identifica el gasto m√°s grande o un √°rea de mejora, y ofrece un consejo financiero conciso y pr√°ctico basado en los datos. La respuesta debe ser formal, en espa√±ol y sin pre√°mbulos, comenzando directamente con el an√°lisis. No uses emojis.";
            
            const userQuery = `
                Datos Financieros Mensuales (Soles Peruanos) para el periodo seleccionado:
                Total Ingresos: ${formatCurrency(totalIncome)}
                Total Gastos: ${formatCurrency(totalExpenses)}
                Balance Neto: ${formatCurrency(netBalance)}
                
                Detalle de Ingresos:
                ${incomeDetails}

                Detalle de Gastos:
                ${expenseDetails}

                Por favor, genera un an√°lisis financiero.
            `;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                tools: [{ "google_search": {} }],
            };
            
            const maxRetries = 3;

            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status >= 400 && response.status < 500) {
                            throw new Error('Error del cliente (4xx). No se puede reintentar.');
                        }
                        throw new Error(`Error de red o servidor: ${response.status}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (text) {
                        // Reemplazar saltos de l√≠nea para un formato limpio
                        analysisResult.innerHTML = `<p class="whitespace-pre-wrap text-gray-700 text-left">${text.replace(/\n/g, '<br>')}</p>`;
                        break;
                    } else {
                        throw new Error('Respuesta de la IA vac√≠a o inesperada.');
                    }

                } catch (error) {
                    console.error(`Intento ${attempt} fallido:`, error.message);
                    if (attempt < maxRetries && error.message.indexOf('4xx') === -1) {
                        await exponentialBackoff(attempt);
                    } else {
                        analysisResult.innerHTML = '<p class="text-red-600 font-semibold text-center">‚ùå Error al generar el an√°lisis. Int√©ntalo de nuevo.</p>';
                        break;
                    }
                }
            }
            analysisButton.disabled = false;
        };


        // --- Funci√≥n de Exportaci√≥n CSV ---
        /**
         * Funci√≥n para exportar todos los ingresos y gastos a un archivo CSV.
         * NOTA: Esta funci√≥n ahora exporta SOLO los datos filtrados actualmente.
         */
        window.exportDataToCSV = () => {
            // 1. Recopilar y unificar solo los datos FILTRADOS (currentIncomes/Expenses)
            const allTransactions = [];
            window.currentIncomes.forEach(t => {
                allTransactions.push({ 
                    date: t.dateObj ? t.dateObj.toLocaleDateString('es-PE') : new Date().toLocaleDateString('es-PE'), 
                    type: 'INGRESO', 
                    name: t.name, 
                    amount: t.amount 
                });
            });
            window.currentExpenses.forEach(t => {
                allTransactions.push({ 
                    date: t.dateObj ? t.dateObj.toLocaleDateString('es-PE') : new Date().toLocaleDateString('es-PE'), 
                    type: 'GASTO', 
                    name: t.name, 
                    amount: t.amount 
                });
            });

            if (allTransactions.length === 0) {
                window.showMessage("No hay transacciones filtradas para exportar.", 'error');
                return;
            }

            // 2. Crear el contenido CSV
            const headers = ["Fecha", "Tipo", "Nombre", "Monto (S/)"];
            const filterLabel = monthFilter.options[monthFilter.selectedIndex].text.replace(/\s/g, '_');
            
            // Funci√≥n para escapar comillas dobles
            const escapeCSV = (str) => {
                if (typeof str === 'string') {
                    return `"${str.replace(/"/g, '""')}"`;
                }
                return str;
            };

            let csvContent = headers.map(escapeCSV).join(",") + "\n";

            allTransactions.forEach(item => {
                const row = [
                    escapeCSV(item.date),
                    escapeCSV(item.type),
                    escapeCSV(item.name),
                    item.amount.toFixed(2)
                ];
                csvContent += row.join(",") + "\n";
            });

            // 3. Crear Blob y forzar la descarga
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            link.setAttribute("href", url);
            link.setAttribute("download", `Finanzas_${filterLabel}_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            window.showMessage(`Datos de ${filterLabel} exportados a CSV con √©xito.`, 'success');
        };

    </script>
</head>
<body class="p-4 sm:p-8 min-h-screen flex items-start justify-center">

    <div class="w-full max-w-4xl bg-white shadow-2xl rounded-xl p-6 sm:p-8 space-y-8">

        <header class="border-b pb-4 border-indigo-100">
            <h1 class="text-4xl font-extrabold text-gray-800">
                üìä Control Financiero (Soles Peruanos)
            </h1>
            <p id="user-id-display" class="text-xs text-gray-500 mt-1" title="ID Completo del Usuario">
                Cargando autenticaci√≥n...
            </p>
        </header>

        <!-- Mensajes de error/√©xito (INCLUYE AUTODIAGN√ìSTICO) -->
        <div id="message-box" class="hidden"></div>

        <!-- Secci√≥n de Resumen General -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
            
            <!-- Total Ingresos -->
            <div class="bg-green-500 text-white rounded-xl p-4 shadow-lg">
                <span class="text-sm font-medium uppercase tracking-wider block">Total Ingresos</span>
                <span id="total-income" class="text-2xl sm:text-3xl font-black">S/ 0.00</span>
            </div>

            <!-- Total Gastos -->
            <div class="bg-red-500 text-white rounded-xl p-4 shadow-lg">
                <span class="text-sm font-medium uppercase tracking-wider block">Total Gastos</span>
                <span id="total-expense" class="text-2xl sm:text-3xl font-black">S/ 0.00</span>
            </div>

            <!-- Balance Neto -->
            <div class="bg-indigo-100 rounded-xl p-4 shadow-lg">
                <span class="text-sm font-medium uppercase tracking-wider block text-gray-700">Balance Neto</span>
                <span id="net-balance" class="text-3xl font-black text-gray-500">S/ 0.00</span>
            </div>
        </div>
        
        <!-- Filtro por Mes -->
        <div class="p-4 bg-indigo-50 rounded-xl border border-indigo-200 shadow-inner">
            <label for="month-filter" class="block text-lg font-semibold text-indigo-700 mb-2">Filtrar por Mes:</label>
            <select id="month-filter" onchange="window.applyFilterAndRecalculate()"
                    class="w-full p-3 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                <option value="all">Cargando...</option>
                <!-- Opciones se llenar√°n con JS -->
            </select>
        </div>


        <!-- Secci√≥n de A√±adir Transacci√≥n (Ingresos y Gastos) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
            <!-- A√±adir Ingreso -->
            <div class="bg-green-50 p-6 rounded-xl border border-green-200 space-y-4">
                <h2 class="text-2xl font-semibold text-green-700 flex items-center">
                    <span class="mr-2">‚ûï</span> Registrar Ingreso
                </h2>
                <div class="flex flex-col sm:flex-row gap-3">
                    <input type="text" id="income-name" placeholder="Ej: Salario, Venta, Regalo"
                           class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500"
                           maxlength="50">
                    <input type="number" id="income-amount" placeholder="S/ 0.00"
                           class="w-full sm:w-28 p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500"
                           min="0.01" step="0.01">
                </div>
                <button onclick="window.addIncome()"
                        class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow-md transition duration-200">
                    A√±adir Ingreso
                </button>
            </div>
            
            <!-- A√±adir Gasto -->
            <div class="bg-red-50 p-6 rounded-xl border border-red-200 space-y-4">
                <h2 class="text-2xl font-semibold text-red-700 flex items-center">
                    <span class="mr-2">‚ûñ</span> Registrar Gasto
                </h2>
                <div class="flex flex-col sm:flex-row gap-3">
                    <input type="text" id="expense-name" placeholder="Ej: Alquiler, Comida, Transporte"
                           class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500"
                           maxlength="50">
                    <input type="number" id="expense-amount" placeholder="S/ 0.00"
                           class="w-full sm:w-28 p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500"
                           min="0.01" step="0.01">
                </div>
                <button onclick="window.addExpense()"
                        class="w-full py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg shadow-md transition duration-200">
                    A√±adir Gasto
                </button>
            </div>
        </div>
        
        <!-- Secci√≥n de Herramientas (An√°lisis IA y Exportar CSV) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

            <!-- An√°lisis Financiero con IA -->
            <div class="bg-indigo-50 p-6 rounded-xl border border-indigo-200 space-y-4">
                <h2 class="text-2xl font-semibold text-indigo-700 flex items-center">
                    <span class="mr-2">üí°</span> An√°lisis Financiero con IA
                </h2>
                <button id="analyze-button" onclick="window.analyzeFinancesWithGemini()"
                        class="w-full py-3 bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-lg shadow-md transition duration-200 transform hover:scale-[1.005] focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50">
                    Obtener An√°lisis y Consejos
                </button>
                <div id="analysis-result" class="p-4 bg-white rounded-lg border border-indigo-100 min-h-[50px] flex items-center justify-center">
                    <p class="text-center text-gray-500 italic">Presiona el bot√≥n para recibir consejos de un asesor financiero virtual.</p>
                </div>
            </div>

            <!-- Exportar a CSV -->
            <div class="bg-gray-100 p-6 rounded-xl border border-gray-300 space-y-4 flex flex-col justify-between">
                <div>
                    <h2 class="text-2xl font-semibold text-gray-700 flex items-center mb-3">
                        <span class="mr-2">üíæ</span> Exportar Registros
                    </h2>
                    <p class="text-sm text-gray-600">Descarga un archivo CSV con tus transacciones **filtradas**.</p>
                </div>
                <button id="export-button" onclick="window.exportDataToCSV()"
                        class="w-full py-3 bg-gray-700 hover:bg-gray-800 text-white font-bold rounded-lg shadow-md transition duration-200 focus:outline-none focus:ring-4 focus:ring-gray-400 focus:ring-opacity-50 mt-4">
                    Descargar CSV
                </button>
            </div>

        </div>

        <!-- Secci√≥n de Detalle de Transacciones -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Lista de Ingresos -->
            <div>
                <h2 class="text-2xl font-semibold text-green-700 mb-4">üìà Detalle de Ingresos</h2>
                <div id="income-list-container" class="list-container rounded-xl border border-green-200 p-2 bg-white shadow-inner">
                    <ul id="income-list">
                        <li class="text-center py-4 text-gray-500 italic">Cargando ingresos...</li>
                    </ul>
                </div>
            </div>

            <!-- Lista de Gastos -->
            <div>
                <h2 class="text-2xl font-semibold text-red-700 mb-4">üìâ Detalle de Gastos</h2>
                <div id="expense-list-container" class="list-container rounded-xl border border-red-200 p-2 bg-white shadow-inner">
                    <ul id="expense-list">
                        <li class="text-center py-4 text-gray-500 italic">Cargando gastos...</li>
                    </ul>
                </div>
            </div>
        </div>
        
    </div>
</body>
</html>



