<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Ingresos y Gastos</title>
    
    <!-- Carga del SDK de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configuraci√≥n de la fuente Inter y Favicon -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí∞</text></svg>">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .list-container {
            max-height: 300px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 transparent;
        }
        .list-container::-webkit-scrollbar {
            width: 6px;
        }
        .list-container::-webkit-scrollbar-track {
            background: transparent;
        }
        .list-container::-webkit-scrollbar-thumb {
            background-color: #cbd5e0;
            border-radius: 3px;
        }
        .stat-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
    </style>
</head>
<body class="min-h-screen py-8 px-4">
    <div class="max-w-6xl mx-auto">
        <div class="glass-card rounded-2xl p-8 mb-8 text-center">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">
                üí∞ Control Financiero Personal
            </h1>
            <p class="text-gray-600 mb-4">Gestiona tus ingresos y gastos en Soles Peruanos</p>
            <div class="flex flex-wrap items-center justify-center space-x-2 sm:space-x-4 text-sm text-gray-500">
                <span id="auth-status-display" class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs sm:text-sm">
                    ‚òÅÔ∏è Autenticando...
                </span>
                <span id="user-id-display" class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs sm:text-sm truncate max-w-[calc(100%-200px)] sm:max-w-none">
                    ID Usuario: Cargando...
                </span>
                <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs sm:text-sm">
                    üí≥ Soles (PEN)
                </span>
            </div>
        </div>

        <div id="message-box" class="hidden mb-6"></div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="stat-card bg-white rounded-2xl p-6 shadow-lg border border-green-200">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Total Ingresos</h3>
                    <span class="text-2xl">üì•</span>
                </div>
                <div class="text-3xl font-bold text-green-600 mb-2" id="total-income">S/ 0.00</div>
                <div class="text-xs text-gray-500">Ingresos del periodo seleccionado</div>
            </div>

            <div class="stat-card bg-white rounded-2xl p-6 shadow-lg border border-red-200">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Total Gastos</h3>
                    <span class="text-2xl">üì§</span>
                </div>
                <div class="text-3xl font-bold text-red-600 mb-2" id="total-expense">S/ 0.00</div>
                <div class="text-xs text-gray-500">Gastos del periodo seleccionado</div>
            </div>

            <div class="stat-card bg-white rounded-2xl p-6 shadow-lg border border-indigo-200">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Balance Neto</h3>
                    <span class="text-2xl">‚öñÔ∏è</span>
                </div>
                <div class="text-3xl font-bold text-gray-600 mb-2" id="net-balance">S/ 0.00</div>
                <div class="text-xs text-gray-500">Resultado financiero neto</div>
            </div>
        </div>

        <div class="glass-card rounded-2xl p-6 mb-8">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-1">üìä Filtro de Periodo</h3>
                    <p class="text-sm text-gray-600">Selecciona el mes que deseas visualizar</p>
                </div>
                <select id="month-filter" 
                        class="bg-white border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 min-w-[200px]">
                </select>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="glass-card rounded-2xl p-6 border border-green-200">
                <div class="flex items-center mb-6">
                    <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                        <span class="text-xl">üíπ</span>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold text-gray-800">Agregar Ingreso</h3>
                        <p class="text-sm text-gray-600">Registra nuevos ingresos</p>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Descripci√≥n</label>
                        <input type="text" id="income-name" placeholder="Ej: Salario, Ventas, Bonificaci√≥n"
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Monto (S/)</label>
                        <input type="number" id="income-amount" placeholder="0.00" step="0.01" min="0.01"
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500">
                    </div>
                    <button id="add-income-btn"
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-xl transition-colors duration-200 flex items-center justify-center">
                        <span class="mr-2">‚ûï</span> Agregar Ingreso
                    </button>
                </div>
            </div>

            <div class="glass-card rounded-2xl p-6 border border-red-200">
                <div class="flex items-center mb-6">
                    <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center mr-3">
                        <span class="text-xl">üìâ</span>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold text-gray-800">Agregar Gasto</h3>
                        <p class="text-sm text-gray-600">Registra nuevos gastos</p>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Descripci√≥n</label>
                        <input type="text" id="expense-name" placeholder="Ej: Alquiler, Comida, Transporte"
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Monto (S/)</label>
                        <input type="number" id="expense-amount" placeholder="0.00" step="0.01" min="0.01"
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500">
                    </div>
                    <button id="add-expense-btn"
                            class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-xl transition-colors duration-200 flex items-center justify-center">
                        <span class="mr-2">‚ûñ</span> Agregar Gasto
                    </button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="glass-card rounded-2xl p-6 border border-indigo-200">
                <div class="flex items-center mb-6">
                    <div class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center mr-3">
                        <span class="text-xl">ü§ñ</span>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold text-gray-800">An√°lisis con IA</h3>
                        <p class="text-sm text-gray-600">Obt√©n insights inteligentes de Gemini</p>
                    </div>
                </div>
                
                <button id="analyze-button"
                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-xl transition-colors duration-200 mb-4 disabled:opacity-50 disabled:cursor-not-allowed">
                    ü§ñ Generar An√°lisis con IA
                </button>
                
                <div id="analysis-result" class="bg-gray-50 rounded-xl p-4 min-h-[120px] shadow-inner">
                    <p class="text-gray-500 text-center italic py-4">
                        Haz clic en el bot√≥n para obtener un an√°lisis inteligente de tus finanzas
                    </p>
                </div>
            </div>

            <div class="glass-card rounded-2xl p-6 border border-gray-200">
                <div class="flex items-center mb-6">
                    <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center mr-3">
                        <span class="text-xl">üíæ</span>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold text-gray-800">Exportar Datos</h3>
                        <p class="text-sm text-gray-600">Guarda tu informaci√≥n en CSV</p>
                    </div>
                </div>
                
                <div class="space-y-3">
                    <button id="export-btn"
                            class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-4 rounded-xl transition-colors duration-200 flex items-center justify-center">
                        <span class="mr-2">üì•</span> Descargar CSV (Datos Filtrados)
                    </button>
                    <p class="text-xs text-gray-500 text-center">
                        Exporta solo las transacciones del periodo seleccionado a formato CSV.
                    </p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="glass-card rounded-2xl p-6 border border-green-200">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-semibold text-gray-800">üì• Historial de Ingresos</h3>
                    <span id="income-count" class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-medium">
                        0 registros
                    </span>
                </div>
                <ul id="income-list" class="list-container space-y-3">
                    <li class="text-center py-4 text-gray-500">Esperando datos...</li>
                </ul>
            </div>

            <div class="glass-card rounded-2xl p-6 border border-red-200">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-semibold text-gray-800">üì§ Historial de Gastos</h3>
                    <span id="expense-count" class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-sm font-medium">
                        0 registros
                    </span>
                </div>
                <ul id="expense-list" class="list-container space-y-3">
                    <li class="text-center py-4 text-gray-500">Esperando datos...</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Script para Firebase, Auth, Firestore y L√≥gica de la App -->
    <script type="module">
        // Importaciones del SDK Modular de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, deleteDoc, onSnapshot, collection, query, where, Timestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURACI√ìN Y AUTENTICACI√ìN FIREBASE (MANDATORIO) ---
        // Variables globales proporcionadas por el entorno de Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Inicializaci√≥n de Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('debug'); // Logging requerido para Canvas

        let userId = null;
        let isAuthReady = false;
        let listenersInitialized = false; // <-- NUEVO: Bandera para asegurar que onSnapshot solo se inicie una vez.
        
        // Variables globales para almacenar TODOS los datos (sin filtrar)
        let allIncomes = []; 
        let allExpenses = []; 
        // Variables para almacenar los datos actualmente filtrados y mostrados
        let currentIncomes = [];
        let currentExpenses = [];
        
        // --- REFERENCIAS DE ELEMENTOS DEL DOM ---
        const elements = {
            incomeName: document.getElementById('income-name'),
            incomeAmount: document.getElementById('income-amount'),
            expenseName: document.getElementById('expense-name'),
            expenseAmount: document.getElementById('expense-amount'),
            totalIncome: document.getElementById('total-income'),
            totalExpense: document.getElementById('total-expense'),
            netBalance: document.getElementById('net-balance'),
            incomeList: document.getElementById('income-list'),
            expenseList: document.getElementById('expense-list'),
            userIdDisplay: document.getElementById('user-id-display'),
            authStatusDisplay: document.getElementById('auth-status-display'),
            messageBox: document.getElementById('message-box'),
            monthFilter: document.getElementById('month-filter'),
            analyzeButton: document.getElementById('analyze-button'),
            analysisResult: document.getElementById('analysis-result'),
            incomeCount: document.getElementById('income-count'),
            expenseCount: document.getElementById('expense-count'),
            addIncomeBtn: document.getElementById('add-income-btn'),
            addExpenseBtn: document.getElementById('add-expense-btn'),
            exportBtn: document.getElementById('export-btn')
        };
        
        // --- UTILIDADES ---

        /** Muestra un mensaje temporal en la caja de notificaciones. */
        function showMessage(message, type = 'error') {
            const icon = type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ùå';
            const bgColor = type === 'success' ? 'bg-green-50' : type === 'warning' ? 'bg-yellow-50' : 'bg-red-50';
            const textColor = type === 'success' ? 'text-green-800' : type === 'warning' ? 'text-yellow-800' : 'text-red-800';
            const borderColor = type === 'success' ? 'border-green-200' : type === 'warning' ? 'border-yellow-200' : 'border-red-200';
            
            elements.messageBox.innerHTML = `
                <div class="flex items-center justify-between p-4 rounded-lg ${bgColor} ${textColor} border ${borderColor}">
                    <div class="flex items-center">
                        <span class="text-lg mr-3">${icon}</span>
                        <span class="font-medium">${message}</span>
                    </div>
                    <button onclick="document.getElementById('message-box').classList.add('hidden')" 
                            class="text-gray-400 hover:text-gray-600">
                        ‚úï
                    </button>
                </div>
            `;
            elements.messageBox.classList.remove('hidden');
            setTimeout(() => {
                elements.messageBox.classList.add('hidden');
            }, 5000);
        }

        /** Formatea un n√∫mero a Soles Peruanos (PEN). */
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-PE', {
                style: 'currency',
                currency: 'PEN'
            }).format(amount);
        }

        /** Convierte un array a formato CSV y dispara la descarga. */
        function exportToCSV(data, filename = 'finanzas_exportadas.csv') {
            if (data.length === 0) {
                showMessage('No hay datos filtrados para exportar.', 'warning');
                return;
            }

            const headers = ['ID', 'Tipo', 'Descripci√≥n', 'Monto', 'Fecha'];
            
            const rows = data.map(item => [
                item.id,
                item.type,
                `"${item.name.replace(/"/g, '""')}"`, // Escapar comillas dobles
                item.amount.toFixed(2),
                new Date(item.timestamp).toLocaleDateString('es-PE')
            ].join(','));
            
            const csvContent = headers.join(',') + '\n' + rows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showMessage('Datos exportados exitosamente.', 'success');
            } else {
                showMessage('Tu navegador no soporta la descarga autom√°tica de CSV.', 'error');
            }
        }


        // --- FUNCIONES CRUD Y MANEJO DE ESTADO ---

        /** Elimina una transacci√≥n de Firestore. */
        window.deleteTransaction = async function(id, type) {
            if (!isAuthReady) return showMessage("Autenticaci√≥n no lista. Intenta de nuevo.", 'warning');
            const collectionName = type === 'income' ? 'incomes' : 'expenses';
            
            try {
                // Ruta: /artifacts/{appId}/users/{userId}/incomes/docId
                const docRef = doc(db, 'artifacts', appId, 'users', userId, collectionName, id);
                await deleteDoc(docRef);
                showMessage(`${type === 'income' ? 'Ingreso' : 'Gasto'} eliminado exitosamente.`, 'success');
                // onSnapshot se encargar√° de actualizar la vista
            } catch (error) {
                console.error("Error al eliminar la transacci√≥n:", error);
                showMessage(`Error al eliminar: ${error.message}`);
            }
        };

        /** Agrega una transacci√≥n a Firestore. */
        async function addTransaction(name, amount, type) {
            if (!isAuthReady) return showMessage("Autenticaci√≥n no lista. Intenta de nuevo.", 'warning');

            if (!name || isNaN(amount) || amount <= 0) {
                showMessage("Por favor, ingresa un nombre y cantidad v√°lida (mayor a 0)");
                return;
            }

            const collectionName = type === 'income' ? 'incomes' : 'expenses';
            
            const transactionData = {
                name: name.trim(),
                amount: parseFloat(amount),
                timestamp: Timestamp.fromDate(new Date()) // Usamos Timestamp de Firestore
            };

            try {
                // Ruta: /artifacts/{appId}/users/{userId}/incomes
                const colRef = collection(db, 'artifacts', appId, 'users', userId, collectionName);
                await addDoc(colRef, transactionData);

                // Limpiar campos
                if (type === 'income') {
                    elements.incomeName.value = '';
                    elements.incomeAmount.value = '';
                } else {
                    elements.expenseName.value = '';
                    elements.expenseAmount.value = '';
                }
                showMessage(`${type === 'income' ? 'Ingreso' : 'Gasto'} registrado exitosamente.`, 'success');

                // onSnapshot se encargar√° de actualizar la vista
            } catch (error) {
                console.error("Error al a√±adir la transacci√≥n:", error);
                showMessage(`Error al a√±adir: ${error.message}`);
            }
        }
        
        /** Renderiza la lista de transacciones y actualiza las estad√≠sticas. */
        function filterAndRenderData() {
            const selectedValue = elements.monthFilter.value;
            let totalIncome = 0;
            let totalExpenses = 0;

            currentIncomes = [];
            currentExpenses = [];
            
            const incomeFilter = income => {
                if (selectedValue === 'all') return true;
                const date = new Date(income.timestamp);
                const month = date.getMonth() + 1;
                const year = date.getFullYear();
                return `${String(month).padStart(2, '0')}-${year}` === selectedValue;
            };

            const expenseFilter = expense => {
                if (selectedValue === 'all') return true;
                const date = new Date(expense.timestamp);
                const month = date.getMonth() + 1;
                const year = date.getFullYear();
                return `${String(month).padStart(2, '0')}-${year}` === selectedValue;
            };
            
            // --- PROCESAR INGRESOS ---
            elements.incomeList.innerHTML = '';
            const filteredIncomes = allIncomes.filter(incomeFilter).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            if (filteredIncomes.length === 0) {
                elements.incomeList.innerHTML = `<li class="text-center py-8 text-gray-400"><div class="text-4xl mb-2">üí∞</div><p class="text-sm">No hay ingresos registrados para este periodo</p></li>`;
            } else {
                filteredIncomes.forEach(income => {
                    totalIncome += income.amount;
                    currentIncomes.push({...income, type: 'income'});
                    
                    const dateStr = new Date(income.timestamp).toLocaleDateString('es-PE');
                    const safeId = income.id;
                    
                    elements.incomeList.innerHTML += `
                        <li class="flex justify-between items-center p-4 bg-green-50 border border-green-200 rounded-lg transition-all duration-200 hover:shadow-md">
                            <div class="flex-1 min-w-0 pr-2">
                                <span class="font-semibold text-gray-800 truncate block">${income.name}</span>
                                <span class="text-xs text-gray-500">${dateStr}</span>
                            </div>
                            <div class="flex items-center space-x-3">
                                <span class="text-lg font-bold text-green-600 shrink-0">
                                    ${formatCurrency(income.amount)}
                                </span>
                                <button onclick="deleteTransaction('${safeId.replace(/'/g, "\\'")}', 'income')" 
                                        class="delete-btn text-gray-400 hover:text-red-500 transition-colors duration-200 p-1 rounded"
                                        title="Eliminar">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </li>
                    `;
                });
            }

            // --- PROCESAR GASTOS ---
            elements.expenseList.innerHTML = '';
            const filteredExpenses = allExpenses.filter(expenseFilter).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            if (filteredExpenses.length === 0) {
                elements.expenseList.innerHTML = `<li class="text-center py-8 text-gray-400"><div class="text-4xl mb-2">üí∏</div><p class="text-sm">No hay gastos registrados para este periodo</p></li>`;
            } else {
                filteredExpenses.forEach(expense => {
                    totalExpenses += expense.amount;
                    currentExpenses.push({...expense, type: 'expense'});

                    const dateStr = new Date(expense.timestamp).toLocaleDateString('es-PE');
                    const safeId = expense.id;

                    elements.expenseList.innerHTML += `
                        <li class="flex justify-between items-center p-4 bg-red-50 border border-red-200 rounded-lg transition-all duration-200 hover:shadow-md">
                            <div class="flex-1 min-w-0 pr-2">
                                <span class="font-semibold text-gray-800 truncate block">${expense.name}</span>
                                <span class="text-xs text-gray-500">${dateStr}</span>
                            </div>
                            <div class="flex items-center space-x-3">
                                <span class="text-lg font-bold text-red-600 shrink-0">
                                    ${formatCurrency(expense.amount)}
                                </span>
                                <button onclick="deleteTransaction('${safeId.replace(/'/g, "\\'")}', 'expense')" 
                                        class="delete-btn text-gray-400 hover:text-red-500 transition-colors duration-200 p-1 rounded"
                                        title="Eliminar">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </li>
                    `;
                });
            }

            // Actualizar estad√≠sticas
            elements.totalIncome.textContent = formatCurrency(totalIncome);
            elements.totalExpense.textContent = formatCurrency(totalExpenses);
            
            const netBalance = totalIncome - totalExpenses;
            elements.netBalance.textContent = formatCurrency(netBalance);

            // Actualizar contadores
            elements.incomeCount.textContent = `${filteredIncomes.length} registros`;
            elements.expenseCount.textContent = `${filteredExpenses.length} registros`;

            // Actualizar estilo del balance neto
            if (netBalance > 0) {
                elements.netBalance.className = 'text-3xl font-bold text-green-600';
            } else if (netBalance < 0) {
                elements.netBalance.className = 'text-3xl font-bold text-red-600';
            } else {
                elements.netBalance.className = 'text-3xl font-bold text-gray-600';
            }
        }

        /** Carga y actualiza los meses en el filtro. */
        function populateMonthFilter(transactions) {
            const months = new Set();
            transactions.forEach(t => {
                const date = new Date(t.timestamp);
                const month = date.getMonth() + 1;
                const year = date.getFullYear();
                months.add(`${String(month).padStart(2, '0')}-${year}`);
            });
            
            const sortedMonths = Array.from(months).sort((a, b) => {
                const [m1, y1] = a.split('-').map(Number);
                const [m2, y2] = b.split('-').map(Number);
                return (y2 * 12 + m2) - (y1 * 12 + m1); // Orden descendente por fecha
            });

            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", 
                                "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

            let optionsHTML = `<option value="all">üìÖ Todos los meses</option>`;
            const today = new Date();
            const currentMonthValue = `${String(today.getMonth() + 1).padStart(2, '0')}-${today.getFullYear()}`;
            let hasCurrentMonth = false;

            sortedMonths.forEach(value => {
                const [monthNum, year] = value.split('-').map(Number);
                const label = `${monthNames[monthNum - 1]} ${year}`;
                const emoji = value === currentMonthValue ? 'üéØ' : 'üìä';
                
                if (value === currentMonthValue) hasCurrentMonth = true;

                optionsHTML += `<option value="${value}" ${value === elements.monthFilter.value ? 'selected' : ''}>${emoji} ${label}</option>`;
            });

            // Si el mes actual no est√° en los datos, lo a√±adimos si no hay una selecci√≥n previa
            if (!hasCurrentMonth && !sortedMonths.includes(currentMonthValue)) {
                 const currentMonthLabel = `${monthNames[today.getMonth()]} ${today.getFullYear()}`;
                 optionsHTML = `<option value="${currentMonthValue}" selected>üéØ ${currentMonthLabel}</option>` + optionsHTML;
                 elements.monthFilter.value = currentMonthValue; // Establecer el valor por defecto si no hay selecci√≥n previa
            } else if (!elements.monthFilter.value) {
                 elements.monthFilter.value = currentMonthValue;
            }

            elements.monthFilter.innerHTML = optionsHTML;
            
        }

        // --- L√ìGICA DE LA IA DE GEMINI (CON EXPONENTIAL BACKOFF) ---
        
        async function fetchWithRetry(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 || response.status >= 500) {
                        throw new Error('Server error or rate limit exceeded');
                    }
                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`API Error: ${response.status} - ${errorBody.error?.message || response.statusText}`);
                    }
                    return response;
                } catch (error) {
                    console.error(`Fetch attempt ${i + 1} failed: ${error.message}`);
                    if (i === maxRetries - 1) throw error; // Re-throw on last attempt
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        async function analyzeFinancesWithGemini() {
            elements.analyzeButton.disabled = true;
            elements.analyzeButton.innerHTML = 'üîÑ Analizando...';
            elements.analysisResult.innerHTML = `
                <div class="text-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-4"></div>
                    <p class="text-gray-500">Generando an√°lisis con IA...</p>
                </div>
            `;
            
            const transactions = [...currentIncomes, ...currentExpenses].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            if (transactions.length === 0) {
                elements.analyzeButton.disabled = false;
                elements.analyzeButton.innerHTML = 'ü§ñ Generar An√°lisis con IA';
                elements.analysisResult.innerHTML = `
                    <div class="bg-gray-50 border border-gray-200 rounded-xl p-4">
                        <h4 class="font-semibold text-gray-800 mb-2">üßê Sin datos para analizar</h4>
                        <p class="text-gray-700 text-sm">
                            Por favor, registra algunos ingresos y gastos para que la IA pueda generar un an√°lisis para el periodo seleccionado.
                        </p>
                    </div>
                `;
                return;
            }

            const totalIncome = currentIncomes.reduce((sum, item) => sum + item.amount, 0);
            const totalExpense = currentExpenses.reduce((sum, item) => sum + item.amount, 0);
            const balance = totalIncome - totalExpense;

            // Construir la tabla de datos para la IA
            const dataTable = transactions.map(t => {
                const sign = t.type === 'income' ? '+' : '-';
                const date = new Date(t.timestamp).toLocaleDateString('es-PE');
                return `${date} | ${t.type.toUpperCase()} | ${t.name} | ${sign}S/${t.amount.toFixed(2)}`;
            }).join('\n');


            const systemPrompt = "Eres un analista financiero personal amigable y experto. Tu tarea es analizar las transacciones proporcionadas en Soles Peruanos (S/) y el balance neto. Debes ser positivo pero objetivo. Proporciona una respuesta concisa de m√°ximo 4 frases, usando emojis para resaltar los puntos clave:\n1. Resumen de la salud financiera y el balance (positivo, negativo, neutro).\n2. Identifica el ingreso y/o gasto m√°s significativo.\n3. Ofrece una recomendaci√≥n accionable para mejorar la situaci√≥n financiera.";
            
            const userQuery = `Analiza el siguiente conjunto de transacciones. El Balance Neto es ${formatCurrency(balance)}. El total de Ingresos es ${formatCurrency(totalIncome)} y el total de Gastos es ${formatCurrency(totalExpense)}. Aqu√≠ est√° el detalle de las transacciones:\n\n${dataTable}`;

            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    elements.analysisResult.innerHTML = `<div class="p-2 text-gray-800 whitespace-pre-wrap">${text}</div>`;
                } else {
                    elements.analysisResult.innerHTML = `<p class="text-red-500 py-4 text-center">Error: La IA no pudo generar un an√°lisis.</p>`;
                }
            } catch (error) {
                console.error("Error al llamar a Gemini API:", error);
                elements.analysisResult.innerHTML = `<p class="text-red-500 py-4 text-center">üö´ Error de conexi√≥n con el servicio de IA. Intenta de nuevo.</p>`;
            } finally {
                elements.analyzeButton.disabled = false;
                elements.analyzeButton.innerHTML = 'ü§ñ Generar An√°lisis con IA';
            }
        }
        
        // --- INICIALIZACI√ìN Y LISTENERS PRINCIPALES ---

        /** Establece los escuchadores de Firestore. */
        function setupFirestoreListeners() {
            if (!isAuthReady || !userId) {
                console.warn("setupFirestoreListeners llamada antes de que la autenticaci√≥n est√© lista.");
                return;
            }

            // 1. Listener para Ingresos
            const incomeColRef = collection(db, 'artifacts', appId, 'users', userId, 'incomes');
            onSnapshot(incomeColRef, (snapshot) => {
                allIncomes = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    // Asegurar que el timestamp sea un formato utilizable por Date
                    timestamp: doc.data().timestamp ? doc.data().timestamp.toDate().toISOString() : new Date().toISOString()
                }));
                const allTransactions = [...allIncomes, ...allExpenses];
                populateMonthFilter(allTransactions); // Actualiza el filtro de meses
                filterAndRenderData(); // Re-renderiza con el filtro actual
            }, (error) => {
                // Este error se registra, pero no deber√≠a bloquear la app una vez que la conexi√≥n se restablece.
                console.error("Error al escuchar ingresos (transitorio):", error);
                showMessage("Error al cargar ingresos en tiempo real. Revisa tus permisos de Firestore.", 'error');
            });

            // 2. Listener para Gastos
            const expenseColRef = collection(db, 'artifacts', appId, 'users', userId, 'expenses');
            onSnapshot(expenseColRef, (snapshot) => {
                allExpenses = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    // Asegurar que el timestamp sea un formato utilizable por Date
                    timestamp: doc.data().timestamp ? doc.data().timestamp.toDate().toISOString() : new Date().toISOString()
                }));
                const allTransactions = [...allIncomes, ...allExpenses];
                populateMonthFilter(allTransactions); // Actualiza el filtro de meses
                filterAndRenderData(); // Re-renderiza con el filtro actual
            }, (error) => {
                // Este error se registra, pero no deber√≠a bloquear la app una vez que la conexi√≥n se restablece.
                console.error("Error al escuchar gastos (transitorio):", error);
                showMessage("Error al cargar gastos en tiempo real. Revisa tus permisos de Firestore.", 'error');
            });
            
            // Mostrar ID de usuario una vez que est√© disponible
            elements.authStatusDisplay.textContent = '‚òÅÔ∏è Conectado (Tiempo Real)';
        }

        /** Inicializa el flujo de autenticaci√≥n. */
        async function initializeAuth() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Error durante la autenticaci√≥n:", error);
                showMessage(`Error de Autenticaci√≥n: ${error.message}`, 'error');
                elements.authStatusDisplay.textContent = '‚ùå Error de Conexi√≥n';
            }
        }

        // Listener de estado de autenticaci√≥n (Se ejecuta una vez al inicio y en cada cambio)
        onAuthStateChanged(auth, (user) => {
            // FIX: Solo inicializar listeners la primera vez que se resuelve el estado de auth.
            if (!listenersInitialized) {
                if (user) {
                    userId = user.uid;
                    elements.userIdDisplay.textContent = `ID Usuario: ${userId}`;
                } else {
                    // Si el token inicial falla o no existe, se usa un ID an√≥nimo para operar.
                    userId = crypto.randomUUID(); 
                    elements.authStatusDisplay.textContent = '‚ö†Ô∏è Sesi√≥n An√≥nima';
                    elements.userIdDisplay.textContent = `ID An√≥nimo: ${userId}`;
                }
                
                isAuthReady = true; // El ID de usuario (autenticado o an√≥nimo) est√° listo
                setupFirestoreListeners(); // Inicia la escucha de datos
                listenersInitialized = true; // Asegura que no se vuelva a llamar
            } else if (user) {
                // Actualizar ID si el usuario cambia (ej. de an√≥nimo a autenticado),
                // pero los listeners ya est√°n establecidos.
                userId = user.uid;
                elements.userIdDisplay.textContent = `ID Usuario: ${userId}`;
            }
        });

        // --- MANEJO DE EVENTOS ---
        
        elements.addIncomeBtn.addEventListener('click', () => {
            addTransaction(elements.incomeName.value, elements.incomeAmount.value, 'income');
        });

        elements.addExpenseBtn.addEventListener('click', () => {
            addTransaction(elements.expenseName.value, elements.expenseAmount.value, 'expense');
        });

        elements.monthFilter.addEventListener('change', filterAndRenderData);

        elements.analyzeButton.addEventListener('click', analyzeFinancesWithGemini);

        elements.exportBtn.addEventListener('click', () => {
            exportToCSV(currentIncomes.concat(currentExpenses).map(t => ({
                id: t.id,
                type: t.type,
                name: t.name,
                amount: t.amount,
                timestamp: t.timestamp
            })), `Finanzas_Export_${elements.monthFilter.value}.csv`);
        });

        // Iniciar el flujo de autenticaci√≥n al cargar la p√°gina
        initializeAuth();
        
    </script>
</body>
</html>
